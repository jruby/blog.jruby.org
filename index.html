<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <title>
    
      The JRuby Blog : JRuby
    
  </title>

  <meta charset="utf-8" />
  <meta name="author" content="Shane Becker" />

  <link href="/feed" rel="alternate" title="No More Sharecropping" type="application/atom+xml" />
  <link rel="home" href="/" />

  <!--[if lt IE 9]> <script src="/javascripts/html5.js"></script> <![endif]-->
  <link rel="stylesheet" href="/stylesheets/syntax.css" />
<link rel="stylesheet" href="/stylesheets/asciidoc.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/stylesheets/application.css" />

</head>

<body>
  <header role="banner">
    <a href="/" rel="home">
      <hgroup>
        <h1>The JRuby Blog</h1>
        <h2>The Ruby Programming Language on the JVM</h2>
      </hgroup>
    </a>
  </header>

  <ul class="hfeed" role="main">
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2022/06/jruby-class-extension-9.3" rel="bookmark">
      <hgroup class="entry-title">
        <h1>Generating Java Classes at Runtime with JRuby 9.3.4</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:" rel="email">Patrick Plenfisch</a>
      <i>on</i> <time pubdate datetime="2022-06-24">June 24, 2022</time>
    </h3>

  </header>

  <section class="entry-content">
    <div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#background">1. Background</a></li>
<li><a href="#constructors">2. Constructors</a></li>
<li><a href="#fields">3. Fields</a></li>
<li><a href="#annotations">4. Annotations</a></li>
<li><a href="#jrubyfx-2-0">5. JRubyFX 2.0</a></li>
<li><a href="#gotchas-classloading-ruby-classes">6. Gotchas: Classloading Ruby Classes</a></li>
<li><a href="#conclusion">7. Conclusion</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="background">1. Background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are many reasons people use the JRuby implementation of Ruby over MRI/CRuby: increased long-run performance, lock-free multi-threading, the ability to deliver code as a war file, and to integrate with Java libraries. I often find my use of JRuby via integrating with Java, and that&#8217;s the topic of this post.</p>
</div>
<div class="paragraph">
<p>First, what types of basic Java integration does JRuby currently provide?</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Embedding JRuby in Java code (JSR-223)</p>
</li>
<li>
<p>Memory/GC integration</p>
</li>
<li>
<p>Marshaling values from Ruby to Java</p>
</li>
<li>
<p>Ruby code calling into Java</p>
</li>
<li>
<p>Marshaling values from Java to Ruby</p>
</li>
<li>
<p>Implementing interfaces so Java can call Ruby</p>
</li>
<li>
<p>Extending a Java class with a Ruby class (concrete extension)</p>
</li>
<li>
<p>Lowering a Ruby class into a JVM class at runtime (reification, <code>become_java!</code>)</p>
</li>
<li>
<p>The <code>jrubyc</code> class compiler that can generate (ahead of time) Java classes</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This post will principally investigate #7 and #8, and some of their recent changes in the JRuby 9.3.4 series. I shall assume a basic knowledge of how the JVM works, and a familiarity with Ruby.</p>
</div>
<div class="paragraph">
<p>First, why would one want to do either #7 or #8? Number 7, henceforth referred to as concrete extension, should hopefully be more obvious, as lots of frameworks and libraries require extending a class, and doing so from Ruby code is simply more convenient when using JRuby than having to bundle an extra jar. Number 8, henceforth referred to as reification, is needed whenever a full JVM class is required, either for multi-interface support, or as a token.</p>
</div>
<div class="paragraph">
<p>As a quick example, lets look at using Logback, a common Java logging framework. Logback (slf4j, really) requires a class as a token to get a logger. The Ruby version uses using concrete extension and reification together.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All examples in here use the <code>maven-require</code> gem to load maven dependencies interactively. Install it via <code>gem install maven-require</code> and then in each <code>irb</code> session or file, <code>require 'maven_require'</code> at the top. Note the differing gem name and require line.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Classic Java Usage of Logback</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="java"><span></span><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.slf4j.Logger</span>;
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">org.slf4j.LoggerFactory</span>;

<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">JavaPiList</span> <span style="color: #008000; font-weight: bold">extends</span> java.<span style="color: #7D9029">util</span>.<span style="color: #7D9029">AbstractList</span><span style="color: #666666">&lt;</span>Integer<span style="color: #666666">&gt;</span> {

    <span style="color: #008000; font-weight: bold">static</span> Logger logger <span style="color: #666666">=</span> LoggerFactory.<span style="color: #7D9029">getLogger</span>(JavaPiList.<span style="color: #7D9029">class</span>);
    <span style="color: #B00040">int</span><span style="color: #666666">[]</span> pi <span style="color: #666666">=</span> {<span style="color: #666666">3</span>,<span style="color: #666666">1</span>,<span style="color: #666666">4</span>,<span style="color: #666666">1</span>,<span style="color: #666666">5</span>,<span style="color: #666666">9</span>};

    <span style="color: #008000; font-weight: bold">public</span> Integer <span style="color: #0000FF">get</span>(<span style="color: #B00040">int</span> index) {
        logger.<span style="color: #7D9029">info</span>(<span style="color: #BA2121">&quot;Getting index {}&quot;</span>, index);
        <span style="color: #008000; font-weight: bold">return</span> pi<span style="color: #666666">[</span>index<span style="color: #666666">]</span>;
    }

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">size</span>() {
        <span style="color: #008000; font-weight: bold">return</span> pi.<span style="color: #7D9029">length</span>;
    }

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">main</span>(String<span style="color: #666666">[]</span> args) {
        <span style="color: #008000; font-weight: bold">new</span> JavaPiList().<span style="color: #7D9029">get</span>(<span style="color: #666666">3</span>);
        <span style="color: #408080; font-style: italic">// =&gt; 12:34:56.789 [main] INFO JavaPiList - Getting index 3</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Ported JRuby Usage of Logback</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="ruby"><span></span><span style="color: #008000">require</span> <span style="color: #BA2121">&#39;jruby/core_ext&#39;</span> <span style="color: #408080; font-style: italic"># required for become_java! to do anything useful</span>
<span style="color: #008000">require</span> <span style="color: #BA2121">&#39;maven_require&#39;</span>
<span style="color: #408080; font-style: italic"># load latest version of logback into this Ruby session</span>
maven_require <span style="color: #BA2121">&quot;ch.qos.logback:logback-classic:RELEASE&quot;</span>

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">RubyPiList</span> <span style="color: #666666">&lt;</span> java<span style="color: #666666">.</span>util<span style="color: #666666">.</span>AbstractList
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">initialize</span>
        <span style="color: #19177C">@pi</span> <span style="color: #666666">=</span> <span style="color: #666666">[3</span>,<span style="color: #666666">1</span>,<span style="color: #666666">4</span>,<span style="color: #666666">1</span>,<span style="color: #666666">5</span>,<span style="color: #666666">9]</span>
    <span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get</span>(index)
        <span style="color: #880000">Logger</span><span style="color: #666666">.</span>info(<span style="color: #BA2121">&quot;Getting index {}&quot;</span>, index)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #19177C">@pi</span><span style="color: #666666">[</span>index<span style="color: #666666">]</span>
    <span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">size</span>()
        <span style="color: #19177C">@pi</span><span style="color: #666666">.</span>length
    <span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #408080; font-style: italic"># Ensure this class is reified</span>
    become_java!
    <span style="color: #880000">Logger</span> <span style="color: #666666">=</span> org<span style="color: #666666">.</span>slf4j<span style="color: #666666">.</span>LoggerFactory<span style="color: #666666">.</span>get_logger(<span style="color: #880000">RubyPiList</span><span style="color: #666666">.</span>java_class)
<span style="color: #008000; font-weight: bold">end</span>
<span style="color: #880000">RubyPiList</span><span style="color: #666666">.</span>new<span style="color: #666666">.</span>get(<span style="color: #666666">3</span>)
<span style="color: #408080; font-style: italic"># =&gt; 12:34:56.789 [main] INFO rubyobj.RubyPiList - Getting index 3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Neat! How is this implemented under the hood in JRuby? We can take a look at the generated classes to find out. But first, we must save the classes generated to a disk somewhere. Luckily, this is easy to do selectively by passing a directory to <code>become_java!</code>, and the generated class will be saved under it:</p>
</div>
<div class="listingblock">
<div class="title">Saving class files</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="ruby"><span></span>become_java!(<span style="color: #BA2121">&quot;/tmp/jruby-dump-folder&quot;</span>)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For some of the examples here I&#8217;ve taken the JVM bytecode generated, and run it through the <a href="https://github.com/JetBrains/intellij-community/tree/master/plugins/java-decompiler/engine">FernFlower</a> decompiler. The code you see may not compile, and those seeking a deeper understanding are encouraged to explore the disassembled JVM bytecode directly. I recommend <a href="https://bytecodeviewer.com/">Bytecode Viewer</a> as it&#8217;s what I used to develop these improvements to JRuby.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, we can look at the decompiled MyRubyClass that JRuby generated for us:</p>
</div>
<div class="listingblock">
<div class="title">Generated MyRubyClass (decompiled)</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="java"><span></span><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">RubyPiList</span> <span style="color: #008000; font-weight: bold">extends</span> AbstractList <span style="color: #008000; font-weight: bold">implements</span> ReifiedJavaProxy {
   <span style="color: #008000; font-weight: bold">private</span> synthetic <span style="color: #008000; font-weight: bold">final</span> ConcreteJavaProxy <span style="color: #008000; font-weight: bold">this</span>$rubyObject;
   <span style="color: #408080; font-style: italic">// ...bookkeeping fields snipped...</span>
   <span style="color: #408080; font-style: italic">// ...constructors snipped...</span>

   <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">size</span>() {
      <span style="color: #008000; font-weight: bold">this</span>.<span style="color: #7D9029">this$rubyObject</span>.<span style="color: #7D9029">ensureThis</span>(<span style="color: #008000; font-weight: bold">this</span>);
      <span style="color: #008000; font-weight: bold">return</span> ((Number)<span style="color: #008000; font-weight: bold">this</span>.<span style="color: #7D9029">this$rubyObject</span>.<span style="color: #7D9029">callMethod</span>(<span style="color: #BA2121">&quot;size&quot;</span>, IRubyObject.<span style="color: #7D9029">NULL_ARRAY</span>).<span style="color: #7D9029">toJava</span>(Integer.<span style="color: #7D9029">TYPE</span>)).<span style="color: #7D9029">intValue</span>();
   }

   <span style="color: #008000; font-weight: bold">public</span> Object <span style="color: #0000FF">get</span>(<span style="color: #B00040">int</span> var1) {
      <span style="color: #008000; font-weight: bold">this</span>.<span style="color: #7D9029">this$rubyObject</span>.<span style="color: #7D9029">ensureThis</span>(<span style="color: #008000; font-weight: bold">this</span>);
      <span style="color: #008000; font-weight: bold">return</span> (Object)<span style="color: #008000; font-weight: bold">this</span>.<span style="color: #7D9029">this$rubyObject</span>.<span style="color: #7D9029">callMethod</span>(<span style="color: #BA2121">&quot;get&quot;</span>,
            <span style="color: #008000; font-weight: bold">new</span> IRubyObject<span style="color: #666666">[]</span>{
                JavaUtil.<span style="color: #7D9029">convertJavaToRuby</span>(ruby, var1)
            }).<span style="color: #7D9029">toJava</span>(Object.<span style="color: #7D9029">class</span>);
   }
   <span style="color: #408080; font-style: italic">// ...bookkeeping methods snipped...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we can see several important facts. First, this is just a proxy for a Ruby class. As the Java class just delegate everything to the Ruby object, all the logic can still be swapped around via monkey patching and it is still dynamic under the hood. The Java class is merely an interface to the Ruby class. Second, there is lots of internal JRuby bookkeeping present, so performance may be lower. Third, all instance variables are not lowered to fields and are still Ruby-private. And fourth, the method signatures were picked up from the superclass.</p>
</div>
<div class="paragraph">
<p>For most JRuby Java integrations this is fine, but sometimes you need to add some more flair to your generated classes. Let us investigate three separate ways to upgrade our integration game with JRuby 9.3.4 improvements to concrete reification:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Java-callable constructors</p>
</li>
<li>
<p>Fields</p>
</li>
<li>
<p>Annotations</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="constructors">2. Constructors</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first issue I ever filed against JRuby was about the lack of java-callable constructors for java-extending classes (concrete extension), in 2012. One anagram and 8½ years later, it was finally closed in 2021, as my implementation was merged into JRuby 9.3.0. What caused me to file the issue, and still want it done in 2021? JavaFX, or more specifically, the JRuby bindings of JavaFX, JRubyFX. JavaFX is a cross-platform GUI toolkit, and my usual go-to for GUI work when I&#8217;m writing Ruby.</p>
</div>
<div class="paragraph">
<p>One of the features that drew me to JavaFX is SceneBuilder, a drag-and-drop GUI designer that produces a runtime-loadable XML (cleverly called FXML) description of the GUI layout. While it&#8217;s possible to use JavaFX/JRubyFX without FXML (and indeed most of the people using JRubyFX seem to not use it), FXML is very useful. Supporting FXML in JRubyFX was tricky, as the JavaFX <code>FXMLLoader</code> reads the FXML to build classes and set fields. It does this by using reflection to call the no-arg constructor of the named class in the FXML. This is where I ran into trouble in 2012, but is now fixed, as of JRuby 9.3.1 (and utilized in JRubyFX 2.0). If you want to be able to call a constructor from Java for a Ruby class extending a Java class, now you can do so, and it&#8217;s configurable:</p>
</div>
<div class="listingblock">
<div class="title">Simple Construction Example</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="ruby"><span></span><span style="color: #008000">require</span> <span style="color: #BA2121">&#39;jruby/core_ext&#39;</span> <span style="color: #408080; font-style: italic"># required for become_java! to do anything useful</span>

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ChaosParrot</span> <span style="color: #666666">&lt;</span> java<span style="color: #666666">.</span>io<span style="color: #666666">.</span>InputStream
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">initialize</span>()
        <span style="color: #008000">puts</span> <span style="color: #BA2121">&quot;ChaosParrot was initialized&quot;</span>
        <span style="color: #19177C">@percent</span> <span style="color: #666666">=</span> <span style="color: #666666">0.1</span>
    <span style="color: #008000; font-weight: bold">end</span>

    java_signature <span style="color: #BA2121">&#39;void setPercent(float)&#39;</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">setPercent</span>(pct)
        <span style="color: #008000">puts</span> <span style="color: #BA2121">&quot;Got percent: </span><span style="color: #BB6688; font-weight: bold">#{</span>pct<span style="color: #BB6688; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
        <span style="color: #19177C">@percent</span> <span style="color: #666666">=</span> pct
    <span style="color: #008000; font-weight: bold">end</span>

    java_signature <span style="color: #BA2121">&#39;void setStream(java.io.InputStream)&#39;</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">setStream</span>(underlying)
        <span style="color: #008000">puts</span> <span style="color: #BA2121">&quot;Got new stream&quot;</span>
        <span style="color: #19177C">@underlying</span> <span style="color: #666666">=</span> underlying
    <span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #408080; font-style: italic"># no java_signature necessary here, as it uses the inherited signatures</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read</span>(<span style="color: #666666">*</span>args)
        <span style="color: #408080; font-style: italic"># for other signatures, use parent</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">super</span><span style="color: #666666">.</span>read(<span style="color: #666666">*</span>args) <span style="color: #008000; font-weight: bold">unless</span> args<span style="color: #666666">.</span>empty?

        <span style="color: #408080; font-style: italic"># corrupt bytes randomly, as configured</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">rand</span>(<span style="color: #666666">256</span>) <span style="color: #666666">^</span> <span style="color: #19177C">@underlying</span><span style="color: #666666">.</span>read <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">rand</span> <span style="color: #666666">&lt;=</span> <span style="color: #19177C">@percent</span>
        <span style="color: #19177C">@underlying</span><span style="color: #666666">.</span>read
    <span style="color: #008000; font-weight: bold">end</span>

    <span style="color: #008000">new</span> <span style="color: #408080; font-style: italic"># if you directly `new` the class, become_java!</span>
    <span style="color: #408080; font-style: italic"># is called if necessary for concrete-extension classes</span>
    <span style="color: #408080; font-style: italic"># but you can always ensure it by calling become_java! directly</span>
<span style="color: #008000; font-weight: bold">end</span>
<span style="color: #408080; font-style: italic"># call the constructor via Java Reflection API&#39;s</span>
us <span style="color: #666666">=</span> <span style="color: #880000">ChaosParrot</span><span style="color: #666666">.</span>java_class<span style="color: #666666">.</span>constructor()<span style="color: #666666">.</span>newInstance
<span style="color: #408080; font-style: italic"># =&gt; ChaosParrot was initialized</span>
us <span style="color: #408080; font-style: italic"># =&gt; #&lt;ChaosParrot:0x1f2e3d4c&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that you can now use any Java object-construction libraries.  Here is a contrived continuation of this example using Spring to construct Ruby objects:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We use <code>ChaosParrot.java_class.name</code> to get the full name, as the <code>rubyobj</code> package is not considered stable release-to-release.
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
We also must pass in an appropriate classloader. See below for issues related to classloading reified classes (both concrete and normal) from java.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Instantiating Ruby Objects from Java via Spring</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="ruby"><span></span><span style="color: #408080; font-style: italic"># ChaosParrot code from above continues here</span>
maven_require <span style="color: #BA2121">&#39;org.springframework&#39;</span>, <span style="color: #BA2121">&#39;spring-context&#39;</span>,<span style="color: #BA2121">&#39;5.3.16&#39;</span>
<span style="color: #008000">require</span> <span style="color: #BA2121">&#39;tempfile&#39;</span>
<span style="color: #880000">Tempfile</span><span style="color: #666666">.</span>open(<span style="color: #BA2121">&quot;beans.xml&quot;</span>) <span style="color: #008000; font-weight: bold">do</span> <span style="color: #666666">|</span>beanxml<span style="color: #666666">|</span>
    <span style="color: #880000">File</span><span style="color: #666666">.</span>write(beanxml<span style="color: #666666">.</span>path, <span style="color: #008000">%Q|&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span style="color: #008000">        &lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span>
<span style="color: #008000">            &lt;bean id=&quot;myparrot&quot; class=&quot;</span><span style="color: #BB6688; font-weight: bold">#{</span><span style="color: #880000">ChaosParrot</span><span style="color: #666666">.</span>java_class<span style="color: #666666">.</span>name<span style="color: #BB6688; font-weight: bold">}</span><span style="color: #008000">&quot;&gt;</span>
<span style="color: #008000">                &lt;property name=&quot;percent&quot; value=&quot;0.25&quot;/&gt;</span>
<span style="color: #008000">            &lt;/bean&gt;</span>
<span style="color: #008000">        &lt;/beans&gt;|</span>)
    ctx <span style="color: #666666">=</span> org<span style="color: #666666">.</span>springframework<span style="color: #666666">.</span>context<span style="color: #666666">.</span>support<span style="color: #666666">.</span>FileSystemXmlApplicationContext<span style="color: #666666">.</span>new
    ctx<span style="color: #666666">.</span>config_location <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;file:</span><span style="color: #BB6688; font-weight: bold">#{</span>beanxml<span style="color: #666666">.</span>path<span style="color: #BB6688; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
    ctx<span style="color: #666666">.</span>class_loader <span style="color: #666666">=</span> <span style="color: #880000">ChaosParrot</span><span style="color: #666666">.</span>java_class<span style="color: #666666">.</span>class_loader <span style="color: #408080; font-style: italic"># See below about classloaders</span>
    ctx<span style="color: #666666">.</span>refresh <span style="color: #408080; font-style: italic"># load the beans!</span>
    <span style="color: #408080; font-style: italic"># =&gt; ChaosParrot was initialized</span>
    <span style="color: #408080; font-style: italic"># =&gt; Got percent: 0.25</span>

    <span style="color: #408080; font-style: italic"># ...do stuff with ctx</span>
<span style="color: #008000; font-weight: bold">end</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Getting type conversion errors about IRubyObject? Ensure you required <code>require 'jruby/core_ext'</code> as it is a no-op by default for <code>jrubyc</code> compatibility.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Dumping the generated class shows us the method that JRuby generates:</p>
</div>
<div class="listingblock">
<div class="title">Generated ChaosParrot Structure (disassembled with javap)</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="java"><span></span><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">rubyobj</span>.<span style="color: #7D9029">ChaosParrot</span> <span style="color: #008000; font-weight: bold">extends</span> InputStream <span style="color: #008000; font-weight: bold">implements</span> ReifiedJavaProxy {
  <span style="color: #408080; font-style: italic">// Java-reflection constructor</span>
  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">ChaosParrot</span>();

  <span style="color: #408080; font-style: italic">// Internal JRuby constructors (::new)</span>
  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">ChaosParrot</span>(Ruby, RubyClass);
  <span style="color: #008000; font-weight: bold">public</span> synthetic <span style="color: #0000FF">ChaosParrot</span>(ConcreteJavaProxy, IRubyObject<span style="color: #666666">[]</span>, Block, Ruby, RubyClass);
  <span style="color: #008000; font-weight: bold">protected</span> synthetic <span style="color: #0000FF">ChaosParrot</span>(ConcreteJavaProxy, <span style="color: #B00040">boolean</span>, IRubyObject<span style="color: #666666">[]</span>, Block, Ruby, RubyClass);
  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">static</span> {};

  <span style="color: #408080; font-style: italic">// Our new methods</span>
  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">setStream</span>(InputStream);
  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">setPercent</span>(<span style="color: #B00040">float</span>);

  <span style="color: #408080; font-style: italic">// Overrides for read (all overloads always added)</span>
  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">read</span>();
  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">read</span>(<span style="color: #B00040">byte</span>...);
  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> <span style="color: #0000FF">read</span>(<span style="color: #B00040">byte</span><span style="color: #666666">[]</span>, <span style="color: #B00040">int</span>, <span style="color: #B00040">int</span>);

  <span style="color: #408080; font-style: italic">// bridge methods so super works (Internal JRuby implementation details)</span>
  <span style="color: #408080; font-style: italic">// Note only 2 here, as read() is abstract in the parent</span>
  <span style="color: #008000; font-weight: bold">public</span> bridge synthetic <span style="color: #B00040">int</span> __super$<span style="border: 1px solid #FF0000">\</span><span style="color: #666666">=</span>rubyobj<span style="border: 1px solid #FF0000">\</span>,ChaosParrot$read(<span style="color: #B00040">byte</span><span style="color: #666666">[]</span>);
  <span style="color: #008000; font-weight: bold">public</span> bridge synthetic <span style="color: #B00040">int</span> __super$<span style="border: 1px solid #FF0000">\</span><span style="color: #666666">=</span>rubyobj<span style="border: 1px solid #FF0000">\</span>,ChaosParrot$read(<span style="color: #B00040">byte</span><span style="color: #666666">[]</span>, <span style="color: #B00040">int</span>, <span style="color: #B00040">int</span>);

  <span style="color: #408080; font-style: italic">// internal JRuby API (ReifiedJavaProxy)</span>
  <span style="color: #008000; font-weight: bold">public</span> synthetic IRubyObject <span style="color: #0000FF">___jruby$rubyObject</span>();
  <span style="color: #008000; font-weight: bold">public</span> synthetic JavaProxyClass <span style="color: #0000FF">___jruby$proxyClass</span>();
}</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Because internally JRuby has the proxy Java class, as well as the Ruby class, and it needs to initialize both of them no matter if initialized from Ruby code via <code>::new</code> or Java code via <code>newInstance</code>, a limitation currently applies to <code>super(&#8230;&#8203;)</code> calls in the configured constructor method (typically <code>initialize</code>, see below): there can be at most one <code>super(&#8230;&#8203;)</code>, with no conditionals over it.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you are curious how these two halves are initialized together, <a href="https://github.com/jruby/jruby/pull/6422#issuecomment-748414730">this initialization diagram</a> is a good place to start
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>One potentially tricky thing, is that of which method to call in initialization. This is particularly acute for JavaFX as the "fxml is loaded" method is called <code>initialize</code>, shadowing the Ruby constructor of the same name. Luckily, the new constructor support in 9.3 allows reconfiguring many aspects of this interaction, owing to the fact that it is merely a proxy generator for Java.</p>
</div>
<div class="paragraph">
<p>In the example below, the method defined as <code>#initialize</code> is never used, as <code>::new</code> has been redefined (via <code>configure_java_class</code>) to call <code>#java_ctor</code>, and calling <code>.initialize</code> from Java is re-routed to <code>#normal_method</code>. By default JRuby, excludes <code>#initialize</code> from generation, so we must explicitly include it here.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Class configuration using <code>configure_java_class</code> is only fully enabled for concrete extension (aka Ruby-subclassing-Java) as of 9.3.4. Non-concrete extension (no Java superclasses) is not fully enabled. There is a bug about this <a href="https://github.com/jruby/jruby/issues/7122">issue #7122</a>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Configuring Java Proxy Class Generation Parameters</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="ruby"><span></span><span style="color: #008000">require</span> <span style="color: #BA2121">&#39;jruby/core_ext&#39;</span> <span style="color: #408080; font-style: italic"># required for become_java! to do anything useful</span>

<span style="color: #408080; font-style: italic"># configuring classes only works for concrete classes right now (JRuby 9.3.4)</span>
<span style="color: #408080; font-style: italic"># so we extends java.lang.Object to force this to be a concrete-extended class</span>
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ConfiguredProxy</span> <span style="color: #666666">&lt;</span> java<span style="color: #666666">.</span>lang<span style="color: #666666">.</span>Object
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">initialize</span>
        <span style="color: #008000">puts</span> <span style="color: #BA2121">&quot;I shouldn&#39;t be called&quot;</span>
    <span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">java_ctor</span>
        <span style="color: #008000">puts</span> <span style="color: #BA2121">&quot;The ctor was called&quot;</span>
    <span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">standard_method</span>
        <span style="color: #008000">puts</span> <span style="color: #BA2121">&quot;The non-ctor was called&quot;</span>
    <span style="color: #008000; font-weight: bold">end</span>
    configure_java_class(<span style="color: #19177C">ctor_name</span>: <span style="color: #BA2121">&quot;java_ctor&quot;</span>) <span style="color: #008000; font-weight: bold">do</span>
        dispatch <span style="color: #19177C">:initialize</span>, <span style="color: #19177C">:standard_method</span> <span style="color: #408080; font-style: italic"># java initialize will call standard_method</span>
        <span style="color: #008000">include</span> <span style="color: #19177C">:initialize</span> <span style="color: #408080; font-style: italic"># excluded by default</span>
    <span style="color: #008000; font-weight: bold">end</span>
    become_java!
<span style="color: #008000; font-weight: bold">end</span>
<span style="color: #880000">ConfiguredProxy</span><span style="color: #666666">.</span>new
<span style="color: #408080; font-style: italic"># =&gt; The ctor was called</span>
inst <span style="color: #666666">=</span> <span style="color: #880000">ConfiguredProxy</span><span style="color: #666666">.</span>java_class<span style="color: #666666">.</span>constructor()<span style="color: #666666">.</span>newInstance
<span style="color: #408080; font-style: italic"># =&gt; The ctor was called</span>
<span style="color: #880000">ConfiguredProxy</span><span style="color: #666666">.</span>java_class<span style="color: #666666">.</span>get_method(<span style="color: #BA2121">&quot;initialize&quot;</span>)<span style="color: #666666">.</span>invoke(inst)
<span style="color: #408080; font-style: italic"># =&gt; The non-ctor was called</span>

<span style="color: #408080; font-style: italic"># you can stil call standard_method directly too, since</span>
<span style="color: #408080; font-style: italic"># it wasn&#39;t excluded or redefined</span>
<span style="color: #880000">ConfiguredProxy</span><span style="color: #666666">.</span>java_class<span style="color: #666666">.</span>get_method(<span style="color: #BA2121">&quot;standard_method&quot;</span>)<span style="color: #666666">.</span>invoke(inst)
<span style="color: #408080; font-style: italic"># =&gt; The non-ctor was called</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Decompiling the result shows that some of our changes (<code>dispatch</code>, <code>include</code>) are baked into the class file itself, while others (<code>ctor_name</code>) can still be edited after class generation:</p>
</div>
<div class="listingblock">
<div class="title">Generated ConfiguredProxy (decompiled)</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="java"><span></span><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ConfiguredProxy</span> <span style="color: #008000; font-weight: bold">implements</span> ReifiedJavaProxy {
   <span style="color: #408080; font-style: italic">// ...bookkeeping fields snipped... (see end for full listing)</span>
   <span style="color: #408080; font-style: italic">// ...some constructors snipped...</span>

   <span style="color: #408080; font-style: italic">// Java no-arg constructor</span>
   <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">ConfiguredProxy</span>() {
      <span style="color: #008000; font-weight: bold">this</span>(<span style="color: #008000; font-weight: bold">new</span> ConcreteJavaProxy(ruby, rubyClass), <span style="color: #008000; font-weight: bold">false</span>, IRubyObject.<span style="color: #7D9029">NULL_ARRAY</span>, Block.<span style="color: #7D9029">NULL_BLOCK</span>, ruby, rubyClass);
   }

   <span style="color: #008000; font-weight: bold">protected</span> synthetic <span style="color: #0000FF">ConfiguredProxy</span>(ConcreteJavaProxy var1, <span style="color: #B00040">boolean</span> var2, IRubyObject<span style="color: #666666">[]</span> var3, Block var4, Ruby var5, RubyClass var6) {
      <span style="color: #008000; font-weight: bold">this</span>.<span style="color: #7D9029">this$rubyObject</span> <span style="color: #666666">=</span> var1;
      <span style="color: #408080; font-style: italic">// the splitInitialized &amp; finishInitialize calls here will invoke whichever</span>
      <span style="color: #408080; font-style: italic">// ruby method is configured as :ctor_name in configure_java_class</span>
      SplitCtorData state <span style="color: #666666">=</span> var1.<span style="color: #7D9029">splitInitialized</span>(var2 <span style="color: #666666">?</span> rubyClass : var6, var3, var4, <span style="color: #008000; font-weight: bold">this</span>$rubyCtorCache);
      <span style="color: #408080; font-style: italic">// snipped bookkeeping...</span>
         <span style="color: #008000; font-weight: bold">super</span>();
         var1.<span style="color: #7D9029">setObject</span>(<span style="color: #008000; font-weight: bold">this</span>);
         var1.<span style="color: #7D9029">finishInitialize</span>(state);
      <span style="color: #408080; font-style: italic">// snipped bookkeeping...</span>
   }

   <span style="color: #408080; font-style: italic">// Since we didn&#39;t specify the signature, it returns</span>
   <span style="color: #408080; font-style: italic">// Ruby objects as the default</span>
   <span style="color: #008000; font-weight: bold">public</span> IRubyObject <span style="color: #0000FF">standard_method</span>() {
      <span style="color: #008000; font-weight: bold">this</span>.<span style="color: #7D9029">this$rubyObject</span>.<span style="color: #7D9029">ensureThis</span>(<span style="color: #008000; font-weight: bold">this</span>);
      <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">this</span>.<span style="color: #7D9029">this$rubyObject</span>.<span style="color: #7D9029">callMethod</span>(<span style="color: #BA2121">&quot;standard_method&quot;</span>);
   }

   <span style="color: #408080; font-style: italic">// the configured dispatch is seen here, dispatching</span>
   <span style="color: #408080; font-style: italic">// to a differently-named method</span>
   <span style="color: #008000; font-weight: bold">public</span> IRubyObject <span style="color: #0000FF">initialize</span>() {
      <span style="color: #008000; font-weight: bold">this</span>.<span style="color: #7D9029">this$rubyObject</span>.<span style="color: #7D9029">ensureThis</span>(<span style="color: #008000; font-weight: bold">this</span>);
      <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">this</span>.<span style="color: #7D9029">this$rubyObject</span>.<span style="color: #7D9029">callMethod</span>(<span style="color: #BA2121">&quot;standard_method&quot;</span>);
   }

   <span style="color: #408080; font-style: italic">// No dispatch configuration, uses same name</span>
   <span style="color: #008000; font-weight: bold">public</span> IRubyObject <span style="color: #0000FF">java_ctor</span>() {
      <span style="color: #008000; font-weight: bold">this</span>.<span style="color: #7D9029">this$rubyObject</span>.<span style="color: #7D9029">ensureThis</span>(<span style="color: #008000; font-weight: bold">this</span>);
      <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">this</span>.<span style="color: #7D9029">this$rubyObject</span>.<span style="color: #7D9029">callMethod</span>(<span style="color: #BA2121">&quot;java_ctor&quot;</span>);
   }

   <span style="color: #408080; font-style: italic">// ...bookkeeping methods snipped...</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fields">3. Fields</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Java/JVM fields and Ruby instance variables are different: fields are fixed, and can be public, protected, or private, while instance variables are only protected, but are dynamic. Nonetheless, when porting Java code to Ruby, or vice-versa, they are typically replaced with each other. JRuby, however, exposes fields differently than instance variables. Fields are accessed by named getters and setters on self, and not related to instance variables (you can set a field and an instance variable of the same name to different values!). If you are accessing existing Java objects this is one thing, but how do you create a Java field on a reified Ruby object, whether concrete-extended or not? With <code>java_field</code>. Here is a contrived example using Jackson, a JSON serializer for Java (Please use one of the ruby serializers in real code, this is just an example of a java library reading fields):</p>
</div>
<div class="listingblock">
<div class="title">Serializing Reified Ruby Classes with Jackson</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="ruby"><span></span><span style="color: #008000">require</span> <span style="color: #BA2121">&#39;jruby/core_ext&#39;</span> <span style="color: #408080; font-style: italic"># required for become_java! to do anything useful</span>
maven_require <span style="color: #BA2121">&#39;com.fasterxml.jackson.core:jackson-databind&#39;</span>

<span style="color: #408080; font-style: italic"># If we are a pure ruby class, internal JRuby fields will be present.</span>
<span style="color: #408080; font-style: italic"># To avoid unnecessary methods and fields on the resulting Java Class,</span>
<span style="color: #408080; font-style: italic"># we decend from Java Object, not Ruby Object</span>
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">FieldedClass</span> <span style="color: #666666">&lt;</span> java<span style="color: #666666">.</span>lang<span style="color: #666666">.</span>Object
    java_field <span style="color: #BA2121">&#39;java.lang.String mystr&#39;</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">initialize</span>(mystr <span style="color: #666666">=</span> <span style="color: #008000">nil</span>)
        <span style="color: #008000; font-weight: bold">super</span>() <span style="color: #408080; font-style: italic"># j.l.Object requires no args</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>mystr <span style="color: #666666">=</span> mystr <span style="color: #008000; font-weight: bold">if</span> mystr <span style="color: #666666">!=</span> <span style="color: #008000">nil</span>
    <span style="color: #008000; font-weight: bold">end</span>
    become_java!
<span style="color: #008000; font-weight: bold">end</span>
om <span style="color: #666666">=</span> com<span style="color: #666666">.</span>fasterxml<span style="color: #666666">.</span>jackson<span style="color: #666666">.</span>databind<span style="color: #666666">.</span>ObjectMapper<span style="color: #666666">.</span>new
str <span style="color: #666666">=</span> om<span style="color: #666666">.</span>write_value_as_string(<span style="color: #880000">FieldedClass</span><span style="color: #666666">.</span>new(<span style="color: #BA2121">&quot;foo&quot;</span>))
<span style="color: #408080; font-style: italic"># =&gt; &quot;{\&quot;mystr\&quot;: \&quot;foo\&quot;}</span>
om<span style="color: #666666">.</span>read_value(str, <span style="color: #880000">FieldedClass</span><span style="color: #666666">.</span>java_class)<span style="color: #666666">.</span>mystr
<span style="color: #408080; font-style: italic"># =&gt; &quot;foo&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This isn&#8217;t very idiomatic Ruby. If we are willing to sacrifice some of the expected semantics of ruby instance variables, we can, as of JRuby 9.3.4, tie the instance variables and the fields together. Instead of being able to store two different values in <code>@name</code> and <code>self.name</code>, they are aliases</p>
</div>
<div class="listingblock">
<div class="title">Serializing Reified Ruby Classes with Jackson, using Instance Variables</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="ruby"><span></span><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">InstancedClass</span> <span style="color: #666666">&lt;</span> java<span style="color: #666666">.</span>lang<span style="color: #666666">.</span>Object
    java_field <span style="color: #BA2121">&#39;java.lang.String mystr&#39;</span>, <span style="color: #19177C">instance_variable</span>: <span style="color: #008000">true</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">initialize</span>(mystr <span style="color: #666666">=</span> <span style="color: #008000">nil</span>)
        <span style="color: #008000; font-weight: bold">super</span>()
        <span style="color: #19177C">@mystr</span> <span style="color: #666666">=</span> mystr <span style="color: #008000; font-weight: bold">if</span> mystr <span style="color: #666666">!=</span> <span style="color: #008000">nil</span>
    <span style="color: #008000; font-weight: bold">end</span>
    become_java!
<span style="color: #008000; font-weight: bold">end</span>
str <span style="color: #666666">=</span> om<span style="color: #666666">.</span>write_value_as_string(<span style="color: #880000">InstancedClass</span><span style="color: #666666">.</span>new(<span style="color: #BA2121">&quot;foo&quot;</span>))
<span style="color: #408080; font-style: italic"># =&gt; &quot;{\&quot;mystr\&quot;: \&quot;foo\&quot;}</span>
om<span style="color: #666666">.</span>read_value(str, <span style="color: #880000">InstancedClass</span><span style="color: #666666">.</span>java_class)<span style="color: #666666">.</span>mystr
<span style="color: #408080; font-style: italic"># =&gt; &quot;foo&quot;</span></code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<code>@name.equals?(@name)</code> may be false in some cases when using this configuration
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
A frozen object can have all instance variables using this configuration modified. Instance variables using this configuration  do not respect if an object is frozen or not.
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
JVM semantics, not Ruby Semantics, apply when using this configuration
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Disassembling, we see this has no affect on the generated proxy class:</p>
</div>
<div class="listingblock">
<div class="title">Generated InstancedClass &amp; FieldedClass Structure (disassembled with javap)</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="java"><span></span><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">FieldedClass</span> <span style="color: #008000; font-weight: bold">implements</span> ReifiedJavaProxy {
  <span style="color: #008000; font-weight: bold">public</span> java.<span style="color: #7D9029">lang</span>.<span style="color: #7D9029">String</span> mystr;
  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">FieldedClass</span>();
  <span style="color: #408080; font-style: italic">// snipped internal ctors and internal JRuby API methods</span>
}
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">InstancedClass</span> <span style="color: #008000; font-weight: bold">implements</span> ReifiedJavaProxy {
  <span style="color: #008000; font-weight: bold">public</span> java.<span style="color: #7D9029">lang</span>.<span style="color: #7D9029">String</span> mystr;
  <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">InstancedClass</span>();
  <span style="color: #408080; font-style: italic">// snipped internal ctors and internal JRuby API methods</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="annotations">4. Annotations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>JRuby 9.3 partly unified the annotation API between <code>become_java!</code> on a pure-ruby class, a concrete-extension Ruby class, and using <code>jrubyc</code> (class-methods only, package and class annotations are not mutually supported). Now the class methods work equally well and with the same syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="ruby"><span></span><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">MyClass</span>
    java_field <span style="color: #BA2121">&#39;full.Type name&#39;</span>
    java_field <span style="color: #BA2121">&#39;@full.Annotation() full.Type name&#39;</span>

    java_signature <span style="color: #BA2121">&#39;full.Type myMethod(primitive, full.Type)&#39;</span>
    java_signature <span style="color: #BA2121">&#39;@full.Annotation() full.Type myMethod(primitive, full.Type)&#39;</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">myMethod</span>(<span style="color: #666666">*</span>args)
        <span style="color: #408080; font-style: italic">#...</span>
    <span style="color: #008000; font-weight: bold">end</span>
<span style="color: #008000; font-weight: bold">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can extend the example from the previous section to have annotations that affect the behavior of Java libraries:</p>
</div>
<div class="listingblock">
<div class="title">Annotations on Generated Java Classes with Jackson</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="ruby"><span></span>maven_require <span style="color: #BA2121">&#39;com.fasterxml.jackson.core&#39;</span>, <span style="color: #BA2121">&#39;jackson-databind&#39;</span>

<span style="color: #408080; font-style: italic"># we extend the Java Object for the same reasons as the previuos example</span>
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">AnnotatedClass</span> <span style="color: #666666">&lt;</span> java<span style="color: #666666">.</span>lang<span style="color: #666666">.</span>Object
    <span style="color: #408080; font-style: italic"># Note we can&#39;t use java_annotation ouside of the class, that is jrubyc only</span>
    add_class_annotations com<span style="color: #666666">.</span>fasterxml<span style="color: #666666">.</span>jackson<span style="color: #666666">.</span>annotation<span style="color: #666666">.</span>JsonRootName <span style="color: #666666">=&gt;</span> {<span style="color: #BA2121">&quot;value&quot;</span> <span style="color: #666666">=&gt;</span> <span style="color: #BA2121">&quot;user&quot;</span>}

    java_field <span style="color: #BA2121">&#39;@com.fasterxml.jackson.annotation.JsonIgnore java.lang.String mystr&#39;</span>
    java_field <span style="color: #BA2121">&#39;int myint&#39;</span>

    java_signature <span style="color: #BA2121">&#39;@com.fasterxml.jackson.annotation.JsonSetter(value=&quot;phantom&quot;) void printItOut(boolean)&#39;</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">printItOut</span>(<span style="color: #008000">p</span>)
        <span style="color: #008000">puts</span> <span style="color: #BA2121">&quot;Phantom set to: </span><span style="color: #BB6688; font-weight: bold">#{</span><span style="color: #008000">p</span><span style="color: #BB6688; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
    <span style="color: #008000; font-weight: bold">end</span>
    become_java!
<span style="color: #008000; font-weight: bold">end</span>
om <span style="color: #666666">=</span> com<span style="color: #666666">.</span>fasterxml<span style="color: #666666">.</span>jackson<span style="color: #666666">.</span>databind<span style="color: #666666">.</span>ObjectMapper<span style="color: #666666">.</span>new
om<span style="color: #666666">.</span>enable(com<span style="color: #666666">.</span>fasterxml<span style="color: #666666">.</span>jackson<span style="color: #666666">.</span>databind<span style="color: #666666">.</span>SerializationFeature<span style="color: #666666">::</span><span style="color: #880000">WRAP_ROOT_VALUE</span>)
om<span style="color: #666666">.</span>write_value_as_string(<span style="color: #880000">AnnotatedClass</span><span style="color: #666666">.</span>new<span style="color: #666666">.</span>tap{<span style="color: #666666">|</span>x<span style="color: #666666">|</span>x<span style="color: #666666">.</span>myint<span style="color: #666666">=9</span>})
<span style="color: #408080; font-style: italic"># =&gt; &quot;{\&quot;user\&quot;:{\&quot;myint\&quot;:9}}&quot;</span>
ac <span style="color: #666666">=</span> om<span style="color: #666666">.</span>read_value(<span style="color: #BA2121">&#39;{&quot;myint&quot;:314,&quot;phantom&quot;:true}&#39;</span>, <span style="color: #880000">AnnotatedClass</span><span style="color: #666666">.</span>java_class)
<span style="color: #408080; font-style: italic"># Phantom set to: true</span>
ac<span style="color: #666666">.</span>myint
<span style="color: #408080; font-style: italic"># =&gt; 314</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Can I avoid typing the package name of the class? Not as of JRuby 9.3. It is <a href="https://github.com/jruby/jruby/issues/5486">issue #5486</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Examining the generated class, we can see it did annotate as we requested:</p>
</div>
<div class="listingblock">
<div class="title">Generated AnnotatedClass Structure (decompiled)</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="java"><span></span><span style="color: #AA22FF">@JsonRootName</span>(<span style="color: #BA2121">&quot;user&quot;</span>)
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">AnnotatedClass</span> <span style="color: #008000; font-weight: bold">implements</span> ReifiedJavaProxy {
   <span style="color: #408080; font-style: italic">// snipped private implementation fields</span>

   <span style="color: #AA22FF">@JsonIgnore</span>
   <span style="color: #008000; font-weight: bold">public</span> String mystr;

   <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">int</span> myint;

   <span style="color: #AA22FF">@JsonSetter</span>(<span style="color: #BA2121">&quot;phantom&quot;</span>)
   <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">printItOut</span>(<span style="color: #B00040">boolean</span> var1) {
      <span style="color: #408080; font-style: italic">// ...</span>
   }
   <span style="color: #408080; font-style: italic">// snipped internal JRuby API parts</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jrubyfx-2-0">5. JRubyFX 2.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After all of these changes in JRuby 9.3.4, the JRubyFX gem can finally dump its FXML hacks and use the existing FXMLLoader by taking advantage of these new features.</p>
</div>
<div class="paragraph">
<p>So, how does JRubyFX use these features for loading FXML?
Every request for loading FXML starts by us loading the file and pulling out all the expected field names from the <code>fx:id</code> attributes, and the <code>onEvent</code> expected event handlers
For each of these names, we call java_field with the FXML annotation, field name, and request that the instance variables are mapped to the fields. This makes the API seem more Ruby-like while two copies of variables. Additionally, most of the pitfalls are likely avoided as these instance variables are typically read, not written, once the FXML file has been loaded.
For each of the event handlers, we define an appropriate event handler method using <code>java_method</code> with the fxml annotation and event handler name
We configure the class for a Java-accessible constructor
We call <code>become_java!</code> and pass the concrete-extended reified class off to the JavaFX FXMLLoader</p>
</div>
<div class="paragraph">
<p>As such, users can experience a straightforward integration experience. For example, while the JVM class is a static and unchangeable interface, by defining all the expected methods and fields, user Ruby code can muck with the class as long as those methods stay defined.</p>
</div>
<div class="paragraph">
<p>Here are some snippets of the above features when integrated into JRubyFX use. Plus, some of the interesting bits of the JRubyFX implementation. See the full working example these were taken from under <a href="https://github.com/jruby/jrubyfx/tree/master/samples/contrib/fxmltableview">samples/contrib/fxmltableview</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
I recommend using Zulu+FX JDK builds for JRubyFX as it is pre-packaged with JavaFX, but any JDK with JavaFX should work (Java 8 and later)
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Fragments of fxmlloader JRubyFX example &amp; JRubyFX implementation</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="ruby"><span></span><span style="color: #408080; font-style: italic"># user usage</span>
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">FormattedTableCellFactory</span>
  <span style="color: #008000">include</span> <span style="color: #880000">Java</span><span style="color: #666666">::</span>javafx<span style="color: #666666">.</span>util<span style="color: #666666">.</span>Callback
  <span style="color: #008000">include</span> <span style="color: #880000">JRubyFX</span>

  <span style="color: #408080; font-style: italic"># see below for fxml_raw_accessor definition</span>
  fxml_raw_accessor <span style="color: #19177C">:alignment</span>, <span style="color: #880000">Java</span><span style="color: #666666">::</span>javafx<span style="color: #666666">.</span>scene<span style="color: #666666">.</span>text<span style="color: #666666">.</span>TextAlignment
  fxml_raw_accessor <span style="color: #19177C">:format</span>, java<span style="color: #666666">.</span>text<span style="color: #666666">.</span>Format

  <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">call</span>(param)
    cell <span style="color: #666666">=</span> <span style="color: #880000">FormattedTableCellFactory_TableCell</span><span style="color: #666666">.</span>new(<span style="color: #19177C">@format</span>)
    cell<span style="color: #666666">.</span>setTextAlignment(<span style="color: #19177C">@alignment</span>)
    <span style="color: #408080; font-style: italic"># ...</span>
  <span style="color: #008000; font-weight: bold">end</span>
  <span style="color: #408080; font-style: italic"># ...</span>
<span style="color: #008000; font-weight: bold">end</span>

<span style="color: #408080; font-style: italic"># library definition</span>
<span style="color: #008000; font-weight: bold">module</span> <span style="color: #0000FF; font-weight: bold">JRubyFX</span>
    <span style="color: #408080; font-style: italic"># ...</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">fxml_raw_accessor</span>(symbol_name, type<span style="color: #666666">=</span>java<span style="color: #666666">::</span>lang<span style="color: #666666">::</span><span style="color: #008000">String</span>)
      <span style="color: #408080; font-style: italic"># ...</span>
      <span style="color: #408080; font-style: italic"># fieldNameGetType() is an extention to standard bean style</span>
      <span style="color: #408080; font-style: italic"># getters/setters in JavaFX</span>
      java_signature <span style="color: #BA2121">&quot;java.lang.Class &quot;</span> <span style="color: #666666">+</span> symbol_name<span style="color: #666666">.</span>id2name <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;GetType()&quot;</span>
      <span style="color: #008000">send</span>(<span style="color: #19177C">:define_method</span>, symbol_name<span style="color: #666666">.</span>id2name <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;GetType&quot;</span>) <span style="color: #008000; font-weight: bold">do</span>
        <span style="color: #008000; font-weight: bold">return</span> type<span style="color: #666666">.</span>java_class
      <span style="color: #008000; font-weight: bold">end</span>
      <span style="color: #408080; font-style: italic"># define the field as fxml-capable</span>
      java_field <span style="color: #BA2121">&quot;@javafx.fxml.FXML </span><span style="color: #BB6688; font-weight: bold">#{</span>type<span style="color: #666666">.</span>java_class<span style="color: #666666">.</span>name<span style="color: #BB6688; font-weight: bold">}</span><span style="color: #BA2121"> </span><span style="color: #BB6688; font-weight: bold">#{</span>symbol_name<span style="color: #BB6688; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, <span style="color: #19177C">instance_variable</span>: <span style="color: #008000">true</span>
    <span style="color: #008000; font-weight: bold">end</span>
<span style="color: #008000; font-weight: bold">end</span>

<span style="color: #408080; font-style: italic"># user usage</span>
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">FXMLTableViewController</span>
  <span style="color: #008000">include</span> <span style="color: #880000">JRubyFX</span><span style="color: #666666">::</span><span style="color: #880000">Controller</span>

  <span style="color: #408080; font-style: italic"># this method call defines all the methods and fields in the provided file</span>
  fxml <span style="color: #BA2121">&quot;fxml_tableview.fxml&quot;</span>

  <span style="color: #408080; font-style: italic"># event handler from the fxml</span>
  <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">addPerson</span>
    <span style="color: #408080; font-style: italic"># the tableview and the fields are</span>
    <span style="color: #408080; font-style: italic"># accessable as instance variables</span>
    data <span style="color: #666666">=</span> <span style="color: #19177C">@tableView</span><span style="color: #666666">.</span>items
    data<span style="color: #666666">.</span>add(<span style="color: #880000">Person</span><span style="color: #666666">.</span>new(<span style="color: #19177C">@firstNameField</span><span style="color: #666666">.</span>text, <span style="color: #666666">...</span>))

    <span style="color: #19177C">@firstNameField</span><span style="color: #666666">.</span>text <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>
    <span style="color: #408080; font-style: italic"># ...</span>
  <span style="color: #008000; font-weight: bold">end</span>
  <span style="color: #408080; font-style: italic"># ...</span>
<span style="color: #008000; font-weight: bold">end</span>

<span style="color: #408080; font-style: italic"># library definition</span>
<span style="color: #008000; font-weight: bold">module</span> <span style="color: #0000FF; font-weight: bold">JRubyFX::FxmlHelper</span>
    <span style="color: #408080; font-style: italic"># ...</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF; font-weight: bold">self</span><span style="color: #666666">.</span><span style="color: #0000FF">transform</span>(clazz, <span style="color: #666666">...</span>) <span style="color: #408080; font-style: italic"># called by fxml in the user code above</span>
        <span style="color: #408080; font-style: italic"># ...</span>
        <span style="color: #008000; font-weight: bold">while</span> xmlStreamReader<span style="color: #666666">.</span>hasNext
            <span style="color: #408080; font-style: italic"># lots of xml processing ...</span>

            <span style="color: #408080; font-style: italic"># if it is an id, save the id and annotate it as injectable by JavaFX. Default to object since the FXMLLoader doesn&#39;t care...</span>
            <span style="color: #008000; font-weight: bold">if</span> localName <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;id&quot;</span> <span style="color: #AA22FF; font-weight: bold">and</span> prefix <span style="color: #666666">==</span> <span style="color: #880000">FXMLLoader</span><span style="color: #666666">::</span><span style="color: #880000">FX_NAMESPACE_PREFIX</span>
              clazz<span style="color: #666666">.</span>instance_eval <span style="color: #008000; font-weight: bold">do</span>
                <span style="color: #408080; font-style: italic"># Note: we could detect the type, but Ruby doesn&#39;t care, and neither does JavaFX&#39;s FXMLLoader</span>
                java_field <span style="color: #BA2121">&quot;@javafx.fxml.FXML java.lang.Object </span><span style="color: #BB6688; font-weight: bold">#{</span>value<span style="color: #BB6688; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, <span style="color: #19177C">instance_variable</span>: <span style="color: #008000">true</span>
              <span style="color: #008000; font-weight: bold">end</span>
            <span style="color: #408080; font-style: italic"># otherwise, if it is an event, add a forwarding call</span>
            <span style="color: #008000; font-weight: bold">elsif</span> localName<span style="color: #666666">.</span>start_with? <span style="color: #BA2121">&quot;on&quot;</span> <span style="color: #AA22FF; font-weight: bold">and</span> value<span style="color: #666666">.</span>start_with? <span style="color: #BA2121">&quot;#&quot;</span>
              <span style="color: #008000">name</span> <span style="color: #666666">=</span> value<span style="color: #666666">[1..-1]</span> <span style="color: #408080; font-style: italic"># strip hash</span>
              clazz<span style="color: #666666">.</span>instance_eval <span style="color: #008000; font-weight: bold">do</span>
                <span style="color: #408080; font-style: italic"># add the fxml signature and correct param count</span>
                java_signature <span style="color: #BA2121">&quot;@javafx.fxml.FXML void </span><span style="color: #BB6688; font-weight: bold">#{</span><span style="color: #008000">name</span><span style="color: #BB6688; font-weight: bold">}</span><span style="color: #BA2121">(javafx.event.Event)&quot;</span>
              <span style="color: #008000; font-weight: bold">end</span>
            <span style="color: #008000; font-weight: bold">end</span>
            <span style="color: #408080; font-style: italic"># ...</span>
        <span style="color: #008000; font-weight: bold">end</span>
        <span style="color: #408080; font-style: italic"># ...</span>
        clazz<span style="color: #666666">.</span>become_java!
    <span style="color: #008000; font-weight: bold">end</span>
<span style="color: #008000; font-weight: bold">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">fxmltableview sample FXML selection (fxml_tableview.fxml)</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="xml"><span></span><span style="color: #008000; font-weight: bold">&lt;GridPane</span> <span style="color: #7D9029">alignment=</span><span style="color: #BA2121">&quot;CENTER&quot;</span> <span style="color: #7D9029">hgap=</span><span style="color: #BA2121">&quot;10.0&quot;</span> <span style="color: #7D9029">vgap=</span><span style="color: #BA2121">&quot;10.0&quot;</span> <span style="color: #7D9029">xmlns:fx=</span><span style="color: #BA2121">&quot;http://javafx.com/fxml&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
  <span style="color: #408080; font-style: italic">&lt;!-- ... --&gt;</span>
  <span style="color: #408080; font-style: italic">&lt;!-- saved in the controller instance variable --&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;TableView</span> <span style="color: #7D9029">fx:id=</span><span style="color: #BA2121">&quot;tableView&quot;</span> <span style="color: #7D9029">GridPane.columnIndex=</span><span style="color: #BA2121">&quot;0&quot;</span> <span style="color: #7D9029">GridPane.rowIndex=</span><span style="color: #BA2121">&quot;1&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;columns&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;TableColumn</span> <span style="color: #7D9029">prefWidth=</span><span style="color: #BA2121">&quot;100.0&quot;</span> <span style="color: #7D9029">text=</span><span style="color: #BA2121">&quot;First Name&quot;</span> <span style="color: #7D9029">fx:id=</span><span style="color: #BA2121">&quot;firstNameColumn&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;cellFactory&gt;</span>
          <span style="color: #408080; font-style: italic">&lt;!-- Build our Ruby class, defined above --&gt;</span>
          <span style="color: #008000; font-weight: bold">&lt;FormattedTableCellFactory</span> <span style="color: #7D9029">alignment=</span><span style="color: #BA2121">&quot;CENTER&quot;</span> <span style="color: #008000; font-weight: bold">/&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/cellFactory&gt;</span>
        <span style="color: #408080; font-style: italic">&lt;!-- ... --&gt;</span>
      <span style="color: #008000; font-weight: bold">&lt;/TableColumn&gt;</span>
      <span style="color: #408080; font-style: italic">&lt;!-- ... --&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/columns&gt;</span>
    <span style="color: #408080; font-style: italic">&lt;!-- ... --&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/TableView&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;HBox</span> <span style="color: #7D9029">alignment=</span><span style="color: #BA2121">&quot;BOTTOM_RIGHT&quot;</span> <span style="color: #7D9029">spacing=</span><span style="color: #BA2121">&quot;10.0&quot;</span> <span style="color: #7D9029">GridPane.columnIndex=</span><span style="color: #BA2121">&quot;0&quot;</span> <span style="color: #7D9029">GridPane.rowIndex=</span><span style="color: #BA2121">&quot;2&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;TextField</span> <span style="color: #7D9029">fx:id=</span><span style="color: #BA2121">&quot;firstNameField&quot;</span> <span style="color: #7D9029">prefWidth=</span><span style="color: #BA2121">&quot;90.0&quot;</span> <span style="color: #7D9029">promptText=</span><span style="color: #BA2121">&quot;First Name&quot;</span> <span style="color: #008000; font-weight: bold">/&gt;</span>
    <span style="color: #408080; font-style: italic">&lt;!-- ... --&gt;</span>
    <span style="color: #408080; font-style: italic">&lt;!-- tied to a our controller method --&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;Button</span> <span style="color: #7D9029">onAction=</span><span style="color: #BA2121">&quot;#addPerson&quot;</span> <span style="color: #7D9029">text=</span><span style="color: #BA2121">&quot;Add&quot;</span> <span style="color: #008000; font-weight: bold">/&gt;</span>
  <span style="color: #008000; font-weight: bold">&lt;/HBox&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/GridPane&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Decompiling some of these classes, we can see the generated fields, method, constructors, and annotations:</p>
</div>
<div class="listingblock">
<div class="title">Select Decompiled Generated Classes from fxmltableview Sample</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="java"><span></span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">FormattedTableCellFactory</span> <span style="color: #008000; font-weight: bold">extends</span> RubyObject <span style="color: #008000; font-weight: bold">implements</span> Reified, Callback {
   <span style="color: #408080; font-style: italic">// snip...</span>
   <span style="color: #AA22FF">@FXML</span>
   <span style="color: #008000; font-weight: bold">public</span> TextAlignment alignment;
   <span style="color: #AA22FF">@FXML</span>
   <span style="color: #008000; font-weight: bold">public</span> Format format;

   <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">FormattedTableCellFactory</span>();

   <span style="color: #008000; font-weight: bold">public</span> TextAlignment <span style="color: #0000FF">getAlignment</span>();
   <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">setAlignment</span>(TextAlignment var1);
   <span style="color: #008000; font-weight: bold">public</span> Class <span style="color: #0000FF">alignmentGetType</span>();

   <span style="color: #008000; font-weight: bold">public</span> Format <span style="color: #0000FF">getFormat</span>();
   <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">setFormat</span>(Format var1);
   <span style="color: #008000; font-weight: bold">public</span> Class <span style="color: #0000FF">formatGetType</span>();

   <span style="color: #408080; font-style: italic">// snip...</span>
}
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">FXMLTableViewController</span> <span style="color: #008000; font-weight: bold">extends</span> RubyObject <span style="color: #008000; font-weight: bold">implements</span> Reified {
   <span style="color: #408080; font-style: italic">// snip...</span>
   <span style="color: #AA22FF">@FXML</span>
   <span style="color: #008000; font-weight: bold">public</span> Object tableView;
   <span style="color: #AA22FF">@FXML</span>
   <span style="color: #008000; font-weight: bold">public</span> Object firstNameColumn;
   <span style="color: #AA22FF">@FXML</span>
   <span style="color: #008000; font-weight: bold">public</span> Object firstNameField;
   <span style="color: #AA22FF">@FXML</span>
   <span style="color: #008000; font-weight: bold">public</span> Object lastNameField;
   <span style="color: #AA22FF">@FXML</span>
   <span style="color: #008000; font-weight: bold">public</span> Object emailField;

   <span style="color: #408080; font-style: italic">// Event Handler</span>
   <span style="color: #AA22FF">@FXML</span>
   <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">addPerson</span>(Event var1);

   <span style="color: #408080; font-style: italic">// snip...</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="gotchas-classloading-ruby-classes">6. Gotchas: Classloading Ruby Classes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are looking up and building Ruby objects from Java code or libraries, pay attention to the classloaders. As of JRuby 9.3.4, no supported built-in way exists to look up reified Ruby classes from Java. If you only need to build one class, you can do what the above Spring demo did, and pass in the single-class classloader of the reified class: <code>MyClass.java_class.classloader</code>. If you need multiple class lookup, you need to write a new classloader.</p>
</div>
<div class="paragraph">
<p>Here is a slightly modified version of the JRubyFX classloader that may be a helpful jumping off point. Note that you must decide where to "mount" your classes, as the built-in <code>rubyobj</code> is not guaranteed to be stable. This mounts all Ruby classes under "Object":</p>
</div>
<div class="listingblock">
<div class="title">Reified Ruby Classloader for Java</div>
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="ruby"><span></span><span style="color: #408080; font-style: italic"># This is a minimal classloader only for classes, resources not supported</span>
<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">PolyglotClassLoader</span> <span style="color: #666666">&lt;</span> java<span style="color: #666666">.</span>lang<span style="color: #666666">.</span>ClassLoader
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">initialize</span>()
      <span style="color: #008000; font-weight: bold">super</span>(<span style="color: #880000">JRuby</span><span style="color: #666666">.</span>runtime<span style="color: #666666">.</span>jruby_class_loader)
      <span style="color: #19177C">@prefix</span> <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Object.&quot;</span>
    <span style="color: #008000; font-weight: bold">end</span>
    java_signature <span style="color: #BA2121">&quot;java.lang.Class findClass(java.lang.String name)&quot;</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">findClass</span>(a)
      <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">nil</span> <span style="color: #008000; font-weight: bold">unless</span> a<span style="color: #666666">.</span>start_with? <span style="color: #19177C">@prefix</span>
      a <span style="color: #666666">=</span> a<span style="color: #666666">[</span><span style="color: #19177C">@prefix</span><span style="color: #666666">.</span>length<span style="color: #666666">..-1]</span> <span style="color: #408080; font-style: italic"># trim prefix</span>
      <span style="color: #008000; font-weight: bold">begin</span>
        <span style="color: #008000; font-weight: bold">return</span> a<span style="color: #666666">.</span>
            <span style="color: #008000">split</span>(<span style="color: #BA2121">&quot;.&quot;</span>)<span style="color: #666666">.</span>
            inject(<span style="color: #880000">Object</span>){ <span style="color: #666666">|</span>value, <span style="color: #008000">name</span><span style="color: #666666">|</span>
                value<span style="color: #666666">.</span>const_get(<span style="color: #008000">name</span>)
            }<span style="color: #666666">.</span>tap{<span style="color: #666666">|</span>x<span style="color: #666666">|</span>
                x<span style="color: #666666">.</span>become_java!
            }<span style="color: #666666">.</span>java_class
      <span style="color: #008000; font-weight: bold">rescue</span> <span style="color: #880000">NameError</span>
        <span style="color: #008000; font-weight: bold">raise</span> java<span style="color: #666666">.</span>lang<span style="color: #666666">.</span>ClassNotFoundException<span style="color: #666666">.</span>new(<span style="color: #BA2121">&quot;Could not find Ruby or Java class &#39;</span><span style="color: #BB6688; font-weight: bold">#{</span>a<span style="color: #666666">.</span>gsub(<span style="color: #BB6688">/[.$]/</span>, <span style="color: #BA2121">&quot;::&quot;</span>)<span style="color: #BB6688; font-weight: bold">}</span><span style="color: #BA2121">&#39; or &#39;</span><span style="color: #BB6688; font-weight: bold">#{</span>a<span style="color: #BB6688; font-weight: bold">}</span><span style="color: #BA2121">&#39;&quot;</span>) <span style="color: #408080; font-style: italic"># Must be a java CNF, not a Ruby Name Error</span>
      <span style="color: #008000; font-weight: bold">end</span>
    <span style="color: #008000; font-weight: bold">end</span>
    become_java!
<span style="color: #008000; font-weight: bold">end</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">7. Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The new features in 9.3.4 make it much easier to integrate Ruby code with Java code doing lots of reflection. Happy Hacking!</p>
</div>
</div>
</div>
  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2015/10/performance_improvements_in_jruby_9030" rel="bookmark">
      <hgroup class="entry-title">
        <h1>Performance Improvements in JRuby 9.0.3.0</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:headius@headius.com" rel="email">Charles Oliver Nutter</a>
      <i>on</i> <time pubdate datetime="2015-10-21">October 21, 2015</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>With the release of JRuby 9000, we promised you’d see our new runtime start to shine in update releases. Now, it’s starting to happen.</p>

<p><a href="http://jruby.org/2015/10/21/jruby-9-0-3-0.html">JRuby 9.0.3.0</a> has been released with three key performance improvements we’re very excited about.</p>

<h2 id="lightweight-postfix-rescues">Lightweight Postfix Rescues</h2>

<p>One of the most convenient anti-patterns in Ruby is the ability to add a <code class="language-plaintext highlighter-rouge">rescue</code> to any expression, capturing all StandardError descendants and instead returning another expression. You see this pattern a lot in code where any exception raised has a trivial fallback.</p>

<p>Unfortunately, exceptions can be very expensive on the JVM. For various reasons, when the JVM generates a stack trace, it has to do much more work than a runtime like CRuby: combining interpreted calls and compiled calls, breaking apart inlined code, omitting or reformatting internal calls. Generating a 1000-deep stack trace on the JVM can cost in the neighborhood of a few milliseconds.</p>

<p>This doesn’t sound like a lot until you start raising thousands of exceptions every second.</p>

<p>Here’s an example from csv.rb, Ruby’s standard library for CSV parsing.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="no">Converters</span>  <span class="o">=</span> <span class="p">{</span> <span class="ss">integer:   </span><span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
                    <span class="no">Integer</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="no">ConverterEncoding</span><span class="p">))</span> <span class="k">rescue</span> <span class="n">f</span>
                  <span class="p">},</span>
                  <span class="ss">float:     </span><span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
                    <span class="no">Float</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="no">ConverterEncoding</span><span class="p">))</span> <span class="k">rescue</span> <span class="n">f</span>
                  <span class="p">},</span>
<span class="o">...</span>
</code></pre></div></div>

<p>Ruby’s CSV library can automatically convert values to Ruby types as they are read. It does this by cascading attempts from one converter to the next using trivial rescues to capture any errors. Each converter executes in turn until one of them is able to convert the incoming data successfully.</p>

<p>Unfortunately, before 9.0.3.0, this had a tremendous impact on performance. Every exception raised here had to generate a very expensive stack trace…ultimately causing CSV value conversions to spend all their time in the guts of the JVM processing stack trace frames.</p>

<p>We received a <a href="https://github.com/jruby/jruby/issues/3348">bug report</a> showing JRuby processing and converting CSV almost 30x slower than CRuby, and we knew we had to do something.</p>

<p>Luckily, with our new runtime, it was easy for to make improvements. Credit goes to Tom Enebo for this <a href="https://github.com/jruby/jruby/issues/3348#issuecomment-145081388">excellent work</a>:</p>

<ul>
  <li>Inspect the expression provided for a rescue to see if it is trivial (local variable, constant value, etc).</li>
  <li>If trivial, entering the rescued code sets a thread-local flag indicating no stack trace will be needed.</li>
  <li>When raising exceptions, we can now omit stack traces we know will never be used.</li>
</ul>

<p>The result? Trivial rescues are now over <a href="https://github.com/jruby/jruby/commit/fb4dcb4ee17a2b6bff8f6c7be8a334cc8b1c6d78">40x faster than before</a> and JRuby handles CSV with conversions considerably faster than CRuby.</p>

<p>Note that this optimization only works when the lightweight rescue is directly upstream from the exception it captures. If there are intevening heavyweight rescues, we can’t optimize the stack trace away.</p>

<h2 id="independently-jitting-blocks">Independently Jitting Blocks</h2>

<p>You can see from the CSV code snippit above that the converters are held in a hash mapping symbols to lambda expressions. This was another case that needed fixing.</p>

<p>JRuby’s JIT has always occurred at method boundaries. If a method is called enough times, we compile it to JVM bytecode. However, there are libraries like CSV where the hot code is not contained within a method…it is a free-standing lambda or proc defined in a script or class body. Because of the limitations of our old JIT, this code would only run in the interpreter, which is generally many times slower than compiled JVM bytecode.</p>

<p>This is frequently compounded by the metaprogramming method <code class="language-plaintext highlighter-rouge">Module#define_method</code>, which allows you to define a new method using only a Ruby block. These definitions usually don’t occur within a method (or at least not within a method we JIT), so they too would never JIT.</p>

<p>In JRuby 9.0.3.0, I finally fixed this by modifying blocks to have their own independent call counters and JIT cycle. If a block is called enough times (currently the same 50-call threshold as methods), they will JIT into JVM bytecode even if the surrounding scope does not. We’ve promised this for years, but it wasn’t until our new runtime that we were able to make it possible.</p>

<p>This improvement makes formerly unjittable blocks anywhere from 5x to 20x faster than they were before.</p>

<p>And speaking of <code class="language-plaintext highlighter-rouge">define_method</code>…</p>

<h2 id="define_method-methods">define_method Methods</h2>

<p>For years we’ve wanted to be able to optimize <code class="language-plaintext highlighter-rouge">define_method</code> methods just like regular methods. The block JIT changes above certainly help that, but it is well known that blocks still have a more overhead (lexical context, heap-based local variables) than regular method bodies.</p>

<p>Once again our new runtime comes to the rescue. Thanks to additional work by Tom, JRuby 9.0.3.0 will now optimize non-capturing <code class="language-plaintext highlighter-rouge">define_method</code> methods (i.e. those that do not access variables from their lexical enclosure) as if they were normal methods. No extra context must be managed, no variables need to go on the heap, and all optimizations that apply to methods work just fine.</p>

<p>For cases where this optimization applies, you’ll see almost no difference in performance between a <code class="language-plaintext highlighter-rouge">define_method</code> method and one defined with the <code class="language-plaintext highlighter-rouge">def</code> keyword.</p>

<p>We don’t plan to stop here, either. For future releases, we plan to make capturing <code class="language-plaintext highlighter-rouge">define_method</code> methods also optimize like regular methods, modulo any context we can’t optimize away. Ideally, these methods should have only a small amount of overhead (or none at all) compared to their regular non-metaprogrammed siblings.</p>

<h2 id="more-to-come">More to Come</h2>

<p>We’re very happy with how JRuby 9000 has been received (our most stable, most compatible, and fastest JRuby ever) and we’ll continue to push the limits of what Ruby can do on the JVM (and what Ruby can do in general).</p>

<p>We’d love to hear what you’re doing with Ruby and JRuby and encourage you to <a href="http://jruby.org/community">join our community</a>!</p>


  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2015/07/jruby_9000" rel="bookmark">
      <hgroup class="entry-title">
        <h1>JRuby 9000</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:team@jruby.org" rel="email">The JRuby Team</a>
      <i>on</i> <time pubdate datetime="2015-07-22">July 22, 2015</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>After years of work, we’re proud to announce the release of <a href="http://jruby.org/2015/07/22/jruby-9-0-0-0.html">JRuby 9000</a>!</p>

<p>JRuby is an implementation of the Ruby programming language atop the Java virtual machine, bringing true parallelism, increased performance, and top-notch garbage collectors to the Ruby world. You can call into other JVM languages, deploy on Java servers, and take advantage of the massive Java tooling ecosystem. At the same time, “It’s Just Ruby”… we pride ourselves on compatibility and on being a Ruby implementation <em>first</em>, and a JVM language <em>second</em>.</p>

<p>We’ve put an enormous amount of effort into this release, and we wanted to share with you why we’re so excited.</p>

<h2 id="compatibility">Compatibility</h2>

<p>During JRuby 1.7.x we had the brilliant idea to support multiple compatibility
levels of Ruby from the same runtime.  If you passed ‘–1.8’ you would be
running JRuby in 1.8.7 compatibility mode. Passing ‘–1.9’ would be running
in1.9.3 compatibility mode.</p>

<p>As it turned out this ended up being extremely messy internally.  We were forced
to start versioning method names (e.g. inspect or
inspect19).  We would get bug reports where we had a 1.9 method
calling a 1.8 method which did the wrong thing.  We confused people making
native extensions – “which method do I call?”  In hindsight, this idea was
too difficult to maintain.</p>

<p>For JRuby 9000 we only support a single version of Ruby.  For 9.0.0.0 we will
support Ruby 2.2, the current version of Ruby.  As new versions of Ruby come out you should expect to see
a version of JRuby come out that supports the same features.</p>

<h2 id="versioning">Versioning</h2>

<p>JRuby 9000 is the ninth major release of JRuby. We opted to go with 9000 as a code name and 9.0.0.0 as a version number to separate it from Ruby’s version numbers (1.8, 1.9, 2.0 etc). We frequently ran into confusion about our version numbers versus Ruby’s, and neither “1.8” nor “2.0” would do anything but make that worse.</p>

<p>Going forward, expect to see maintenance releases versioned as 9.0.x and Ruby compatibility updates numbered as 9.x.</p>

<h2 id="new-runtime">New Runtime</h2>

<p>More than five years ago Subramanya Sastry (subbu) expressed an interest in
helping us work on a new runtime for JRuby.  It was based, in part, on his
PhD experience designing a static optimizing compiler for Java.  From this
beginning, we have worked with subbu to build a new runtime (called IR) which
will look pretty familiar to anyone who has ever taken a compiler course in
college.</p>

<p>For JRuby 9000, this new runtime runs things about as fast as JRuby 1.7 but we
have years worth of plans for improving performance.  At this point, we are
only executing conservative static optimizations. Over the next several months
we will start enabling profiled optimizations and things will start to get
exciting.  The ability to perform more aggressive optimizations like unboxed
math and inlining methods and the blocks they call will open up
an entire new dimension for JRuby’s performance.</p>

<p>IR is the beginning of a new road for performance for JRuby.  We hope to
ship continual performance improvements during our point releases.</p>

<h2 id="native-process-and-io">Native Process and IO</h2>

<p>During the JRuby 9000 dev cycle, we decided it was time to improve the POSIX behavior of our Process and IO subsystems.
In C Ruby, IO and Process are implemented directly atop the standard C library functions. As a result, they reflect behaviors
often hidden when running Java applications, where those APIs are wrapped in many layers of abstraction. For example, a
subprocess launched from Java can’t be read from in a nonblocking way, can’t be signaled, can’t inherit open files and
from the parent process, and many other limitations. In short, we realized we’d need to go native to be truly compatible.</p>

<p>JRuby 9000 now uses native operations for much of IO and almost all of Process. This makes us the first
POSIX-friendly JVM language, with full support for spawning processes, inheriting open streams, perfoming nonblocking
operations on all types of IO, and generally fitting well into a POSIX environment.</p>

<h2 id="years-of-work">Years of Work</h2>

<p>We first started talking about the next JRuby a few years ago, and the IR work started years before that. JRuby 9000 represents
the largest (by far!) release we’ve ever done.</p>

<ul>
  <li>Just counting the time since we branched, there have been over 5500 commits by 104 contributors. That’s a rate of 7 commits
<em>per day</em> for two years.</li>
  <li>We fixed 468 issues during our preview and release candidate cycle. Your bug reports were crucial to delivering a high quality release.</li>
</ul>

<p>With all the work that has gone into JRuby 9000, we’re very proud of what we’ve achieved.</p>

<h2 id="installing-jruby">Installing JRuby</h2>

<p>JRuby 9000 can be installed in the same ways as previous versions. If you are using Windows, we recommend the <a href="https://github.com/jruby/jruby/wiki/GettingStarted#microsoft-windows">Windows Executable installer</a>. If you are using Linux or Mac OS X, we recommend <a href="https://github.com/jruby/jruby/wiki/GettingStarted#using-rvm">using RVM</a> by running the command <code class="language-plaintext highlighter-rouge">rvm install jruby-9.0.0.0</code>.</p>

<p>You can also install the JRuby 9000 binaries by downloading the latest TAR or ZIP file from the JRuby Downloads page, and putting the bin directory on your PATH. For more information on installing JRuby, see the <a href="https://github.com/jruby/jruby/wiki/GettingStarted">Getting Started with JRuby</a> guide on the Wiki.</p>

<h2 id="your-turn">Your Turn</h2>

<p>We’re a very friendly community and we welcome all users to our <a href="http://lists.ruby-lang.org/cgi-bin/mailman/listinfo/jruby">mailing list</a>, our IRC channel (#jruby on Freenode), and our <a href="https://twitter.com/jruby">team Twitter account</a>. File bugs against our <a href="https://github.com/jruby/jruby">Github project</a> and check out our <a href="http://jruby.org/community">community page</a> for more information.</p>

<p>Welcome to the future…<a href="http://jruby.org/2015/07/22/jruby-9-0-0-0.html">JRuby 9000</a> is here!</p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2014/01/truffle_graal_high_performance_backend" rel="bookmark">
      <hgroup class="entry-title">
        <h1>A Truffle/Graal High Performance Backend for JRuby</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:chrisgseaton@gmail.com" rel="email">Chris Seaton</a>
      <i>on</i> <time pubdate datetime="2014-01-06">January 06, 2014</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>For the past year <a href="https://labs.oracle.com">Oracle Labs</a> have been working on an implementation of Ruby built upon two new JVM technologies - <a href="http://openjdk.java.net/projects/graal/">the Truffle AST interpreter framework and the Graal JVM compiler</a>. We believe that the new approach will lead to a faster and simpler Ruby implementation.</p>

<p>We’ve been talking to Charles Nutter and Thomas Enebo for several months and have given them early access to our code. We’ve also been talking to other Ruby implementors such as Alex Gaynor of Topaz, and presenting our results to the JVM language community at the <a href="http://medianetwork.oracle.com/video/player/2623645003001">JVM language summit</a>. Today we are open sourcing our implementation and, with the consent of Charles and Thomas, pushing a patch that begins the integration as an optional backend in JRuby.</p>

<p>This blog post describes some of the background to this project. The <a href="http://hg.openjdk.java.net/graal/graal">original code</a> is available in the Graal Mercurial repository and the <a href="https://github.com/jruby/jruby/tree/truffle">patch to JRuby</a> is available in a new <code class="language-plaintext highlighter-rouge">truffle</code> branch in the JRuby Git repository. There is <a href="https://github.com/jruby/jruby/wiki/Truffle">documentation of how to use the code and an FAQ</a> in the JRuby wiki, as well as pointers to more in-depth technical information such as peer-reviewed research publications.</p>

<h1 id="what-does-this-new-implementation-do-differently">What does this new implementation do differently?</h1>

<p>The new backend is an AST interpreter. We call it the Truffle backend because it’s written using the <a href="http://openjdk.java.net/projects/graal/">Truffle framework for writing AST interpreters</a> from Oracle Labs.</p>

<p>Truffle is different to other AST interpreters in that it creates ASTs that specialize as they execute. The AST interpretation methods that are currently in JRuby are megamorphic, which means that they must handle all possible types and other dynamic conditions such as branches taken. In Truffle, AST nodes ideally handle a minimal set of conditions, allowing them to be simpler and more statically typed, which can lead to more efficient code. In the less common case that the node’s conditions aren’t met the node is replaced with another node that can handle them.</p>

<p>AST interpreters are generally thought of as being slow. This is because every operation becomes something such as a virtual method call. MRI 1.8 used a simple AST interpreter, and JRuby still uses an AST interpreter by default for the first run of methods. To improve performance many language implementations convert the AST to bytecode. Python, Ruby 1.9 and above (via YARV) and PHP all do this. Normally the bytecode is still interpreted, but it’s often faster as the data structure is more compactly represented in memory. In the case of many JVM languages like JRuby and other Ruby implementations such as Topaz and Rubinius, this bytecode is eventually compiled into machine code by the JIT compiler.</p>

<p>Again, Truffle takes a different approach here. When running on JVM with the Graal JIT compiler, Truffle will take all of the methods involved in interpreting your AST and will combine them into a single method. The powerful optimisations that the JVM usually applies to single methods are applied across the combined AST methods and a single machine code function per Ruby method is emitted by Graal.</p>

<p>For more information about what Truffle and Graal do see the <a href="https://github.com/jruby/jruby/wiki/Truffle">JRuby wiki page</a>, the a recent <a href="http://www.slideshare.net/ThomasWuerthinger/graal-truffle-ethdec2013">project summary slide deck</a>.</p>

<h1 id="is-this-going-to-change-with-how-i-use-jruby-today">Is this going to change with how I use JRuby today?</h1>

<p>The Truffle backend, Truffle itself, and Graal are research projects and are certainly not ready for general use today. It is very unlikely that your application or gem will run right now, but if you are interested in the JRuby internals, or the JVM or compiler technology in general we’d encourage you to take a look at what we’re doing. The <a href="https://github.com/jruby/jruby/wiki/Truffle">JRuby wiki page</a> will give you a starting point.</p>

<p>For the foreseeable future this work is going to live on a separate <a href="https://github.com/jruby/jruby/tree/truffle"><code class="language-plaintext highlighter-rouge">truffle</code> branch</a> in the main JRuby Git repository. It is possible that this branch will be considered for merging into the master branch before the next major release, JRuby 9000, but this a decision for the wider JRuby community and its leadership.</p>

<p>We believe that in the further future the Truffle backend could be good enough to become the default backend for JRuby, but again this is a decision for the JRuby community.</p>

<h1 id="what-are-we-going-to-do-next">What are we going to do next?</h1>

<p>We are going to continue to integrate Truffle into JRuby at the same time as continuing to implement more of the Ruby language. We already have very encouraging results with our initial implementation and with the excellent work already done by the JRuby community we think we can fill in the gaps to be a complete implementation.</p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2014/01/jruby-stickers-now-available" rel="bookmark">
      <hgroup class="entry-title">
        <h1>JRuby Stickers now available</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:asari.ruby@gmail.com" rel="email">Hiro Asari</a>
      <i>on</i> <time pubdate datetime="2014-01-05">January 05, 2014</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>JRuby stickers are now ready for shipping!</p>

<p><img src="https://db.tt/O6WPg5lO" alt="JRuby Stickers" /></p>

<p>If you want one, fill out the <a href="https://docs.google.com/forms/d/1_c80K_XfRmQmRybd3aLvZhWswzFXET9NZvN-uweP47M/viewform">form</a>
and send $2 for each sticker via <a href="https://square.com/cash">Square Cash</a>
to community@jruby.org.</p>

<p>Additionally, we will be handing them out when some of the core members
attend the upcoming conferences.</p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2012/08/a_last_hurrah_for_jruby_1_6" rel="bookmark">
      <hgroup class="entry-title">
        <h1>A Last Hurrah For JRuby 1.6</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:headius@headius.com" rel="email">Charles Oliver Nutter</a>
      <i>on</i> <time pubdate datetime="2012-08-27">August 27, 2012</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>Summer is wrapping up and the JRuby team is busy putting the finishing touches on
JRuby 1.7, our next major release. How major? It has taken us almost 1.5 years to
get to this point. That’s major.</p>

<p>Of course, we weren’t sitting on our hands that whole time. For about 8 months
after the release of JRuby 1.6 last year, we continued putting out point releases
to catch bugs, improve Ruby 1.9 support, and fix performance and concurrency
issues you faithful JRuby users reported. Even as late as the waning days of 2011,
we were putting out security-fix releases like <a href="http://jruby.org/2012/05/01/jruby-1-6-7-2">JRuby 1.6.7.2</a>.</p>

<p>But as of today, it has been eight months since a proper JRuby release. That’s too
long.</p>

<p>JRuby 1.7 has had two preview releases, the most recent a couple weeks ago. And
JRuby 1.7 final is scheduled to come out toward the end of September. There are
already users with 1.7 in production, and we’re confident it’s going to be an
amazing release. But we also recognize that many users are still on JRuby 1.6
and may not be able to migrate for some time.</p>

<p><em>So, by popular demand, we’re going to release JRuby 1.6.8!</em></p>

<p>This release will be a bit of an experiment in that the core JRuby team will not
directly contribute to it. We’re looking to community members like you to
backport interesting fixes from JRuby 1.7 (or just come up with new fixes, where
the 1.7 versions require extensive work). We will run our usual slate of release
testing and actually do the legwork of putting out release artifacts, but this
version of JRuby is yours to make what you will!</p>

<p>We’d like to get JRuby 1.6.8 out soon…like the end of next week. Here’s
how you can help:</p>

<ul>
  <li>
    <p>If you are running a patched version of JRuby 1.6.x right now, sort out the
patches you need and send us pull requests against the <a href="https://github.com/jruby/jruby/tree/jruby-1_6">jruby-1_6 branch on
Github</a>.</p>
  </li>
  <li>
    <p>If you know of fixes from 1.7 you need on your 1.6-based systems, do the
same thing, ideally by using git format-patch so the original committer is
associated with the pull request.</p>
  </li>
  <li>
    <p>Make sure your changes pass at least the following test runs: “ant
test-extended”, “rake spec:ci_interpreted_18”, and “rake spec:ci_interpreted_19”.
If the patch affects the compiler, you might want to run the “compiled” version
of the “spec:ci” targets.</p>
  </li>
</ul>

<p>We will then have a look at your pull request, merge it in, and look at a full
JRuby 1.6.8 release in about two weeks.</p>

<p>If you’d like to try out early builds of JRuby 1.6.8, you can download dev
artifacts from <a href="http://ci.jruby.org/snapshots/1.6.x/">JRuby’s CI server</a>.</p>

<p>JRuby 1.6.8 will really, truly be the last in the 1.6.x line, so this is your
chance to make it a good transition before JRuby 1.7. Now go forth and
backport patches!</p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2012/05/bridging-the-gap-with-jruby" rel="bookmark">
      <hgroup class="entry-title">
        <h1>Bridging The Gap With JRuby</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:bploetz@gmail.com" rel="email">Brian Ploetz</a>
      <i>on</i> <time pubdate datetime="2012-05-18">May 18, 2012</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>The only things certain in life are death, taxes, and your technology stack will change over time.
While architectural changes are complicated in their own right, the challenges are even greater when
your primary data store is changing to a fundamentally different technology.</p>

<p>A recent project involved migrating applications from a legacy architecture based on Java/Hibernate/Oracle
to a new architecture based on Ruby/MongoMapper/MongoDB. In order to facilitate the transition from Oracle
to MongoDB, we needed a temporary <a href="http://en.wikipedia.org/wiki/Extract,_transform,_load">ETL</a> solution to
migrate data from Oracle to MongoDB. A new domain model and document structure had been designed and developed
for MongoDB with Ruby/MongoMapper, and there were existing Java/Hibernate entities mapped to Oracle.</p>

<p>Rather than having to re-map one database or the other in the other persistence technology to facilitate the
ETL process (not <a href="http://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY</a>), JRuby allowed the two persistence
technologies to interoperate. By utilizing JRuby’s powerful embedding capabilities, we were able to read data
out of Oracle via Hibernate and write data to MongoDB via MongoMapper.</p>

<h2 id="example-domain-model">Example Domain Model</h2>

<p>To demonstrate the RDMBS to MongoDB ETL process, consider the ubiquitous blog domain model.</p>

<p><img src="/images/jruby-etl-model.png" alt="blog domain model" /></p>

<p>A Blog contains many Posts, and a Post contains many Comments. Users create Posts and Comments. The relational model for
this domain model would look something like this:</p>

<p><img src="/images/jruby-etl-erdiagram.png" alt="blog ER diagram" /></p>

<p>The schema is highly normalized. Entities live in their own tables, and are tied together via foreign keys.</p>

<p>With document databases like MongoDB, you typically want to denormalize data according to your access patterns,
as you can’t rely on joins. In our example blog domain model, storing posts and comments in separate collections
would result in unnecessary querying. Thus, these will become embedded collections within their respective parent
documents, and our resulting Blog MongoDB document would look something like this:</p>

<script src="https://gist.github.com/2312479.js"> </script>

<p><code class="language-plaintext highlighter-rouge">posts</code> is an embedded collection within a <code class="language-plaintext highlighter-rouge">blog</code> document, and <code class="language-plaintext highlighter-rouge">comments</code> is an embedded collection within a
<code class="language-plaintext highlighter-rouge">post</code> document. We denormalize the username of the author of posts/comments, and also store the user’s ObjectId,
which will allow us to generate links like</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Posted by &lt;a href="http://myblog.com/users/4f7d0176f1bb3e1223000005"&gt;bill&lt;/a&gt;
</code></pre></div></div>

<h2 id="translators">Translators</h2>

<p><code class="language-plaintext highlighter-rouge">Translator</code> classes are Ruby classes which translate Java/Hibernate objects to their Ruby/MongoMapper counterparts,
and contain the logic for dealing with denormalization.</p>

<p>Let’s look at an example. The Hibernate domain model class for Blog would look something like this:</p>

<script src="https://gist.github.com/2313375.js"> </script>

<p>Its MongoMapper counterpart would look something like this:</p>

<script src="https://gist.github.com/2313387.js"> </script>

<p>The <code class="language-plaintext highlighter-rouge">BlogTranslator</code> class contains the logic to translate Blog entities to Blog documents:</p>

<script src="https://gist.github.com/2625209.js"> </script>

<p>Some things to note:</p>

<ul>
  <li>Each <code class="language-plaintext highlighter-rouge">Translator</code> is idempotent and knows whether to create or update the document in MongoDB. We store the
RDBMS identifer of the source entity in the MongoDB document to facilitate this logic.</li>
  <li><code class="language-plaintext highlighter-rouge">Translators</code> can call other <code class="language-plaintext highlighter-rouge">Translators</code> as they traverse the Hibernate model’s object graph. Above we see
that the <code class="language-plaintext highlighter-rouge">BlogTranslator</code> calls the <code class="language-plaintext highlighter-rouge">PostTranslator</code> to translate each associated post.</li>
  <li>Having each <code class="language-plaintext highlighter-rouge">Translator</code> be responsible for a single entity (or logical entity) allows you to plug the <code class="language-plaintext highlighter-rouge">Translator</code> into
your applications to perform real-time incremental ETL as entities are created/updated, as well as chain
<code class="language-plaintext highlighter-rouge">Translators</code> together to create large scale batch sync ETL processes.</li>
</ul>

<h2 id="embedding-translators-in-java">Embedding Translators in Java</h2>

<p>With the use of JRuby’s <a href="http://jruby.org/apidocs/org/jruby/embed/ScriptingContainer.html"><code class="language-plaintext highlighter-rouge">ScriptingContainer</code></a>
class, we can embed our <code class="language-plaintext highlighter-rouge">Translator</code> objects into our Java applications to facilitate the ETL process. Suppose we
have a command line app which ETLs all Blog entities. It would embed the <code class="language-plaintext highlighter-rouge">BlogTranslator</code> and pass each Blog
Hibernate model object to the <code class="language-plaintext highlighter-rouge">BlogTranslator</code> object’s <code class="language-plaintext highlighter-rouge">translate</code> method.</p>

<script src="https://gist.github.com/2625336.js"> </script>

<h2 id="example-etl-application">Example ETL application</h2>

<p>A complete RDBMS -&gt; MongoDB ETL application for our blog domain model can be found here:</p>

<p><a href="https://github.com/bploetz/jruby-etl">https://github.com/bploetz/jruby-etl</a></p>

<p>The repository contains two main directories: <code class="language-plaintext highlighter-rouge">java</code> and <code class="language-plaintext highlighter-rouge">ruby</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">java</code> directory contains the Hibernate domain model mapped to the relational database, as well as the
example <code class="language-plaintext highlighter-rouge">ETLManager</code> class which demonstrates JRuby’s embedding capability.</p>

<p>The <code class="language-plaintext highlighter-rouge">ruby</code> directory is a RubyGem containing the MongoMapper domain model mapped to MongoDB, as well as
the <code class="language-plaintext highlighter-rouge">Translator</code> classes.</p>

<p>To run this project the following are required:</p>
<ul>
  <li>JDK 1.5 or higher</li>
  <li>Maven 2.2</li>
  <li>JRuby (examples below assume JRuby is installed via <a href="https://rvm.beginrescueend.com/">RVM</a>)</li>
  <li>The <a href="http://gembundler.com/">Bundler</a> gem installed</li>
  <li><a href="http://www.mongodb.org/display/DOCS/Quickstart">MongoDB</a> running on the default port at localhost</li>
</ul>

<p>For simplicity, this example application uses HSQLDB for the RDBMS, so there is no need to have a separate
RDBMS installed/running. You can obviously change the Spring/Hibernate configuration to use your RDBMS of
choice if you so desire.</p>

<p>Clone the <a href="https://github.com/bploetz/jruby-etl">jruby-etl</a> git repository and run the following to compile the Java source files and create the distribution:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rvm use jruby
cd java-etl/java
mvn clean package
</code></pre></div></div>

<p>cd to the distribution directory and load the example seed data into the relational database.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd target/jruby-etl-1.0.0-SNAPSHOT-bin/bin
./load-seed-data.sh
</code></pre></div></div>

<p>Finally, run the ETL app to translate the seed data from the relational database to MongoDB.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./etl.sh
</code></pre></div></div>

<p>The project is configured to log all SQL statements and all MongoDB queries so that you can see the translation happening.</p>

<p>This ETL application is just one example of how JRuby can help facilitate bridging Java and Ruby based technologies. What
interesting solutions are you building with JRuby?</p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2012/04/two-apps-one-trinidad" rel="bookmark">
      <hgroup class="entry-title">
        <h1>Using Trinidad to Run Multiple Apps</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:jpkutner@gmail.com" rel="email">Joe Kutner</a>
      <i>on</i> <time pubdate datetime="2012-04-06">April 06, 2012</time>
    </h3>

  </header>

  <section class="entry-content">
    <p><em>This is part of a series of blog posts leading up to <a href="http://jrubyconf.com">JRubyConf 2012</a>. Joe Kutner is author of <a href="http://pragprog.com/book/jkdepj/deploying-with-jruby" title="Deploy with JRuby">Deploying with JRuby</a> and an expert on JRuby deployment options. Joe will be attending and speaking at JRubyConf…<a href="http://www.eventbrite.com/event/2571529514">register for JRubyConf 2012</a> today!</em></p>

<p>One of the advantages of running Ruby on the JVM is that we can deploy multiple applications to the same webserver.  Using one JRuby webserver means that there is only one process to manage, monitor, start and stop. Your sysadmins will thank you.</p>

<p>Having mutliple applications on one virtual machine also means we can configure them to share resources, thus reducing the overhead required for a production server.  In this post, we’ll walk through an example of deploying two applications to one Trinidad server.</p>

<p>Trinidad is a light-weight JRuby web server that runs Rails and Rack applications in an embedded Apache Tomcat container.  Let’s install it by running this command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gem install trinidad -v 1.3.4
</code></pre></div></div>

<p>Next, let’s create a Trinidad home directory.  The examples in this post will use <code class="language-plaintext highlighter-rouge">/opt/trinidad</code>, but you can use whatever you’d like.</p>

<p>Under the <code class="language-plaintext highlighter-rouge">/opt/trinidad</code> directory, we’ll create two more directories called <code class="language-plaintext highlighter-rouge">thing1</code> and <code class="language-plaintext highlighter-rouge">thing2</code>, which will contain the applications we’re going to run on our single Trinidad server.  In the <code class="language-plaintext highlighter-rouge">thing1</code> directory, create a <code class="language-plaintext highlighter-rouge">config.ru</code> file and put this code in it:</p>

<script src="https://gist.github.com/2254164.js&#63;file=thing1_config.ru">
<!--
require 'rubygems'
require 'sinatra'

get '/' do
  "This is thing one!"
end

run Sinatra::Application
-->
</script>

<p>In the <code class="language-plaintext highlighter-rouge">thing2</code> directory, create another <code class="language-plaintext highlighter-rouge">config.ru</code> file and put this code in it:</p>

<script src="https://gist.github.com/2254164.js&#63;file=thing2_config.ru">
<!--
require 'rubygems'
require 'sinatra'

get '/' do
  "This is thing two!"
end

run Sinatra::Application
-->
</script>

<p>Next, we’ll create a <code class="language-plaintext highlighter-rouge">/opt/trinidad/trinidad.yml</code> file, which will be used to configure our Trinidad server.</p>

<script src="https://gist.github.com/2254164.js?file=trinidad.yml">
<!--
web_apps:
  default:                                  # use the "/" context
    web_app_dir: '/opt/trinidad/thing1'
  thing2:                                   # use the "/thing2" context
    web_app_dir: '/opt/trinidad/thing2'
-->
</script>

<p>Our Trinidad home directory should look like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/opt/trinidad/
|-- trinidad.yml/
|-- thing1/
    `-- config.ru/
`-- thing2/
    `-- config.ru/
</code></pre></div></div>

<p>Before we start the server, let’s make sure Sinatra is installed by running this command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gem install sinatra
</code></pre></div></div>

<p>Now we can run our Trinidad server by executing this command:</p>

<script src="https://gist.github.com/2254164.js?file=run.sh">
<!--
trinidad &#8208;&#8208;config /opt/trinidad/trinidad.yml
-->
</script>

<p>As the server starts up, we’ll see that its instatiated two runtimes – one for each of our applications.  We can see each of them by browsing to <code class="language-plaintext highlighter-rouge">http://localhost:3000</code> and <code class="language-plaintext highlighter-rouge">http://localhost:3000/thing2</code>.</p>

<p>The two applications are completely isolated.  That means if you monkey-patch the <code class="language-plaintext highlighter-rouge">String</code> class in one application, it won’t affect the other application.  If you set a global variable to a constant value in one application, you can set it to a different value in the other application.</p>

<p>Now let’s move on and really take advantage of what we’ve created!</p>

<p>Because these applications are running in the same JVM, they can share a Database Connection Pool.  To do this, we’ll need to use the <code class="language-plaintext highlighter-rouge">trinidad_dbpool_extension</code>.  Trinidad provides an extension mechanism that allows us to plug-in many kinds of features.They are particularly useful when we need to hook into the embedded Tomcat container, as our database connection pool will.</p>

<p>To use the <code class="language-plaintext highlighter-rouge">trinidad_dbpool_extension</code>, we’ll need to add an <code class="language-plaintext highlighter-rouge">extensions:</code> entry to our <code class="language-plaintext highlighter-rouge">trinidad.yml</code> file.  The new entry will contain the configuration for the Database Connection Pool.  The entire file should look like this now:</p>

<script src="https://gist.github.com/2254164.js?file=trinidad2.yml">
<!--
web_apps:
  default:
    web_app_dir: '/opt/trinidad/thing1'
  thing2:
    web_app_dir: '/opt/trinidad/thing2'
extensions:
  postgresql_dbpool:                                   
    jndi: 'jdbc/trinidad'                           
    username: 'postgres'                              
    password: 'Passw0rd'                              
    url: 'jdbc:postgresql://localhost:5432/trinidad' 
-->
</script>

<p>The extension creates the database connection pool inside the Tomcat container and gives it a JNDI name.  JNDI is a registry service for resources inside of a JVM.</p>

<p>You’ll have to use a real database for this to work, but you don’t have to use PostgreSQL.  The extension also supports MySQL, MSSQL, Oracle, and a generic adapter that covers most other JDBC implementations.</p>

<p>Next, let’s use the pool in our applications.  Change the <code class="language-plaintext highlighter-rouge">thing1/config.ru</code> file to look like this:</p>

<script src="https://gist.github.com/2254164.js?file=config.ru">
<!--
require 'rubygems'
require 'sinatra'
require 'active_record'

get '/' do
  ActiveRecord::Base.establish_connection(
    :adapter => "jdbcpostgresql",
    :jndi => "java:/comp/env/jdbc/trinidad"
  )

  r = ActiveRecord::Base.connection.execute(
    "select count(*) from pg_catalog.pg_tablespace")

  "Thing one found: #{r.inspect}"
end

run Sinatra::Application
-->
</script>

<p>First, we’ve loaded the <code class="language-plaintext highlighter-rouge">active_record</code> Gem, which we’ll use to interface with our database.  Next, we’ve added two statements to our <code class="language-plaintext highlighter-rouge">get</code> service.  The first statement establishes a connection from the pool by referencing the JNDI resource we definined earlier.  The second line executes a simple query against PostgreSQL’s internal tables.  Finally, we’re returning the result of the query as the service response.</p>

<p>Next, modify <code class="language-plaintext highlighter-rouge">thing2/config.ru</code> so it looks similar to the code above, but with “Thing two” in the response.</p>

<p>Before we can launch these applications, we’ll need to install a few more gems by running these commands:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gem install activerecord 
$ gem install trinidad_postgresql_dbpool_extension 
$ gem install activerecord-jdbcpostgresql-adapter
</code></pre></div></div>

<p>Now kill the Trinidad server if it’s still running by pressing <code class="language-plaintext highlighter-rouge">Ctrl+C</code> from it’s console, and start it up again by running this command once more:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ trinidad --config /opt/trinidad/trinidad.yml
</code></pre></div></div>

<p>When we point our browser to <code class="language-plaintext highlighter-rouge">http://localhost:3000</code> and <code class="language-plaintext highlighter-rouge">http://localhost:3000/thing2</code> we’ll see something like this (depending on the number of tables in your database):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Thing one found: [{"count" =&gt; 0}]
</code></pre></div></div>

<p>Both applications are connecting to the database!</p>

<p>Sharing a database connection pool simplifies our production architecture by eliminating the need for additional layers like pg_pool. Trinidad makes it very easy to configure, but this same kind of setup can be achieved with any JRuby web server – including TorqueBox and Warbler+Tomcat/Jetty/etc.</p>

<p>If you found this useful, I encourage you to pick up a copy of my book, <a href="http://pragprog.com/book/jkdepj/deploying-with-jruby" title="Deploy with JRuby">Deploying with JRuby</a>, which has tons of other JRuby examples like this one.</p>

<p>The complete source for this example can be found on Github at <a href="https://github.com/jkutner/trinidad-dbpool-example" title="trinidad-dbpool-example">trinidad-dbpool-example</a>.</p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2012/01/rubygems-https" rel="bookmark">
      <hgroup class="entry-title">
        <h1>Rails 3.2 and Rubygems.org source</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:nick@nicksieger.com" rel="email">Nick Sieger</a>
      <i>on</i> <time pubdate datetime="2012-01-31">January 31, 2012</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>We announced this on Twitter, but it’s important enough to put here
for posterity.</p>

<blockquote class="twitter-tweet"><p>FYI, since 3.2 <a href="https://t.co/Zxl4M5tA" title="https://rubygems.org">rubygems.org</a> is the default Gemfile source, this means you need to have jruby-openssl installed before "rails new".</p>&mdash; JRuby Dev Team (@jruby) <a href="https://twitter.com/jruby/status/164376150209069056" data-datetime="2012-01-31T15:55:02+00:00">January 31, 2012</a></blockquote>
<script src="//platform.twitter.com/widgets.js" charset="utf-8">
</script>

<p>To clarify, the following is put in <code class="language-plaintext highlighter-rouge">Gemfile</code> for new Rails 3.2 apps:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>source 'https://rubygems.org'
</code></pre></div></div>

<p>This means that the <code class="language-plaintext highlighter-rouge">jruby-openssl</code> gem <em>must be installed</em> before you
can generate a new Rails application.</p>

<p>An alternative is to run <code class="language-plaintext highlighter-rouge">rails new --skip-bundle</code>, ensure
<code class="language-plaintext highlighter-rouge">jruby-openssl</code> is installed, and then run <code class="language-plaintext highlighter-rouge">bundle install</code> inside
your new application.</p>

<p>We’re looking at options for incorporating more of jruby-openssl into
JRuby proper without importing the export-controlled crypto bits
(which is the reason we don’t currently ship <code class="language-plaintext highlighter-rouge">jruby-openssl</code> with
JRuby). If you’re <a href="https://github.com/jruby/jruby-ossl/">interested, join us</a>.</p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2012/01/jruby-at-square" rel="bookmark">
      <hgroup class="entry-title">
        <h1>JRuby at Square</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:nick@nicksieger.com" rel="email">Nick Sieger</a>
      <i>on</i> <time pubdate datetime="2012-01-27">January 27, 2012</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>At <a href="http://www.meetup.com/SF-Bay-Area-JRuby-Meetup/events/44244252/">this month’s past SF JRuby Meetup</a> Xavier Shay gave a
compelling experience report on Square’s expanding use of JRuby.</p>

<p>He also announces the open-sourcing of <a href="https://github.com/square/jetpack">Jetpack</a>, Square’s tool for
deploying JRuby applications in their production environment.</p>

<object width="640" height="360"><param name="movie" value="http://www.youtube.com/v/hMpd4CzR1f8&amp;hl=en_US&amp;feature=player_embedded&amp;version=3" />&lt;/param&gt;<param name="allowFullScreen" value="true" />&lt;/param&gt;<param name="allowScriptAccess" value="always" />&lt;/param&gt;<embed src="http://www.youtube.com/v/hMpd4CzR1f8&amp;hl=en_US&amp;feature=player_embedded&amp;version=3" type="application/x-shockwave-flash" allowfullscreen="true" allowscriptaccess="always" width="640" height="360" />&lt;/embed&gt;</object>

<p>(Thanks to <a href="http://marakana.com/forums/ruby/ruby_on_rails/615.html">Marakana TechTV</a> for recording and posting the talk!)</p>


  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2011/12/monitoring-memory_allocation-per-thread" rel="bookmark">
      <hgroup class="entry-title">
        <h1>Monitoring Memory Allocation Per Thread</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:headius@headius.com" rel="email">Charles Oliver Nutter</a>
      <i>on</i> <time pubdate datetime="2011-12-29">December 29, 2011</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>Perhaps the largest benefit of JRuby being on the JVM is the excellent tool ecosystem.
There’s an enormous collections of debuggers, profilers, and general monitoring tools
available for JVM that work great with JRuby. Even better, a surprising number of these
tools are built into each JVM.</p>

<p>One of these tool sets is the <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/management/package-summary.html"><code class="language-plaintext highlighter-rouge">java.lang.management</code></a>
package. Here, you’ll find a number of <a href="http://www.oracle.com/technetwork/java/javase/tech/javamanagement-140525.html">JMX</a> beans for monitoring the status and health
of the JVM. Some of the information presented by these beans is standard, like <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/management/ManagementFactory.html#getMemoryPoolMXBeans()">lists
of memory pools</a>
(heaps) or the <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/management/OperatingSystemMXBean.html#getAvailableProcessors()">number of available processors</a>
on the current system. But each JVM may also expose additional information.</p>

<p>On OpenJDK, starting with 6u25, the built-in <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/management/ThreadMXBean.html"><code class="language-plaintext highlighter-rouge">ThreadMXBean</code></a>
exposes an additional operation: <code class="language-plaintext highlighter-rouge">getThreadAllocatedBytes</code>. How can JRubyists take
advantage of it?</p>

<h2 id="monitoring-thread-allocation">Monitoring Thread Allocation</h2>

<p>Of course, via JRuby’s Java integration, we can easily call any of the management beans’
operations, and <code class="language-plaintext highlighter-rouge">getThreadAllocatedBytes</code> is no different.</p>

<p>We start by loading the ‘java’ and ‘jruby’ libraries, to access Java classes and some
normally-hidden JRuby features.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require 'java'
require 'jruby'
</code></pre></div></div>

<p>We get access to the <code class="language-plaintext highlighter-rouge">ThreadMXBean</code> via the <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/management/ManagementFactory.html"><code class="language-plaintext highlighter-rouge">ManagementFactory</code></a> 
class.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>thread_bean = java.lang.management.ManagementFactory.thread_mx_bean
</code></pre></div></div>

<p>Now, we will create a thread that endlessly creates a new string, and get references
to that thread’s and the main thread’s native <code class="language-plaintext highlighter-rouge">java.lang.Thread</code> object.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>t1 = Thread.new do
  a = nil
  loop do
    a = 'foo'
  end
end
t1_thread = JRuby.reference(t1).native_thread

main = Thread.current
main_thread = JRuby.reference(main).native_thread
</code></pre></div></div>

<p>Now that we’ve got a thread busily allocating data, we set up a loop that prints out
both threads’ allocated bytes once every second. The <code class="language-plaintext highlighter-rouge">getThreadAllocatedBytes</code>
method takes an array of thread IDs and returns an array of byte counts, both as
long[].</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>loop do
  sleep 1
  t1_alloc = thread_bean.get_thread_allocated_bytes([t1_thread.id].to_java(:long))[0]
  main_alloc = thread_bean.get_thread_allocated_bytes([main_thread.id].to_java(:long))[0]
  puts "main allocated: #{main_alloc}"
  puts "t1 allocated: #{t1_alloc}"
end
</code></pre></div></div>

<p>(Note the bit of Java integration array-munging; par for the course going from Ruby’s
heterogeneous Array to Java’s homogeneous arrays.)</p>

<p>And that’s it! Here’s the output on my system for five iterations of the loop:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>main allocated: 11343752
t1 allocated: 378806608
main allocated: 11359632
t1 allocated: 767226768
main allocated: 11361624
t1 allocated: 1156928944
main allocated: 11363616
t1 allocated: 1547160976
main allocated: 11365608
t1 allocated: 1930237360
</code></pre></div></div>

<p>I’ve gisted the full script here: <a href="https://gist.github.com/1533906">Monitoring Thread Allocation</a>.</p>

<h2 id="your-turn">Your Turn</h2>

<p>This is just one of many fun (and useful!) ways you can monitor the JVM using JRuby.
Poke around in <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/management/ManagementFactory.html"><code class="language-plaintext highlighter-rouge">ManagementFactory</code></a>
and see what else you can find!</p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2011/12/getting_started_with_jruby_and_java_7" rel="bookmark">
      <hgroup class="entry-title">
        <h1>Getting Started with JRuby and Java 7</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:headius@headius.com" rel="email">Charles Oliver Nutter</a>
      <i>on</i> <time pubdate datetime="2011-12-19">December 19, 2011</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>Unless you’ve been living under a rock, you’ve probably heard about the new hotness for JRuby:
Java 7’s support for dynamic languages. You may also have heard about the huge perf gains
that JRuby’s seeing when running on Java 7. How can you try it yourself?</p>

<h2 id="get-java-7">Get Java 7</h2>

<p>The reference implementation for Java is <a href="http://openjdk.java.net/">OpenJDK</a>, and
<a href="http://openjdk.java.net/projects/jdk7/">OpenJDK 7</a> has been out for almost six months now.
The current version is 7u2 (‘u’ stands for ‘update’), and includes a
<a href="http://www.oracle.com/technetwork/java/javase/2col/7u2bugfixes-1394661.html">number of improvements</a>
over the GA (‘General Availability’) release.</p>

<p>Most platforms have easy access to OpenJDK builds. I’ll summarize the steps here.</p>

<h3 id="linux-windows-and-solaris">Linux, Windows, and Solaris</h3>

<p>Oracle provides binary downloads for Windows, Linux, and Solaris on its site. The <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">JavaSE
Downloads</a> page links to
both JDK and JRE download pages. You’ll probably want the JDK, since it includes other
JVM-related dev tools, but the JRE will work too. Download, install, and you’re ready.</p>

<p>Additionally, package managers for Linux and Solaris will likely soon have OpenJDK 7u2
packages available, if they don’t already.</p>

<h3 id="os-x">OS X</h3>

<p>The official <a href="http://jdk7.java.net/macportpreview/">preview of OpenJDK for OS X</a> lags behind,
but you can get the current builds from the
<a href="http://code.google.com/p/openjdk-osx-build/">openjdk-osx-build</a> project. The build
you want is currently labeled “OpenJDK-OSX-1.7-x64-u2-b21”, but any build labeled “1.7”
and “u2” in the future will get what you need. The .dmg provides either a self-contained
JDK for you to drop onto your system or a .pkg installer that does it for you.</p>

<p><em>Update</em>: Henri Gomez, the primary guy behind openjdk-osx-build, has set up a page specifically
for the update builds. Grab the JDK or JRE from his
<a href="http://code.google.com/p/openjdk-osx-build/wiki/OpenJDK7JDK7UOSX">OpenJDK7JDK7UOSX</a> page.</p>

<p><em>Update 2</em>: Oracle now has a supported build of <a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk-7u4-downloads-1591156.html">Java 7 update 4 for OS X</a>, so you can get it
from them! It only supports Lion, though, so if you’re on Snow Leopard you will still need
to use a build from Henri or build it yourself.</p>

<h3 id="bsd">*BSD</h3>

<p>The OS X work is based off the “bsd-port” branch of OpenJDK. There are links to Java 7 package
information for FreeBSD, NetBSD, DragonFly BSD, and OpenBSD on the
<a href="https://wikis.oracle.com/display/OpenJDK/BSDPort">BSD Port wiki</a>. These may not be updated to
7u2 yet.</p>

<h2 id="why-update-2">Why Update 2?</h2>

<p>We haven’t previously made a lot of noise about Java 7 and JRuby, nor assembled a
blog post/tutorial like this, primarily because Java 7 GA was missing key optimizations
in the invokedynamic subsystem. JRuby 1.7 will make heavy use of invokedynamic, and if we had
released it before those optimizations were in place, it would have given people a bad
impression of the power of invokedynamic.</p>

<p>Update 2 now has a small set of optimizations that make a very large difference. If you intend
to start playing with JRuby 1.7 builds, we strongly recommend you use OpenJDK 7u2 or higher.</p>

<p><em>Update</em>: Your <code class="language-plaintext highlighter-rouge">jruby -v</code> output should look something like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jruby 1.7.0.dev (ruby-1.8.7-p352) (2011-12-19 f404f75) (OpenJDK 64-Bit Server VM 1.7.0-u2-b21) [darwin-amd64-java]
</code></pre></div></div>

<p>The important bit is that “u2” appear somewhere in that line.</p>

<h2 id="getting-jruby">Getting JRuby</h2>

<p>Of course getting JRuby is always pretty easy.</p>

<h3 id="jruby-16x-current-release">JRuby 1.6.x (current release)</h3>

<p>The current release of JRuby is always available on the <a href="http://jruby.org">JRuby homepage</a>.
Here, you’ll find tarballs, zipfiles, Windows installers, and JRuby in other forms. Download,
unpack, add bin/ to PATH, and you’re ready.</p>

<p>If you want to get the leading edge of the JRuby 1.6 line, including fixes that have not yet
been released, you can download a nightly snapshot from JRuby’s
<a href="http://ci.jruby.org/snapshots/release">release snapshots page</a>.</p>

<p>You can also install JRuby through RVM or rbenv, using <code class="language-plaintext highlighter-rouge">rvm install jruby</code> or
<code class="language-plaintext highlighter-rouge">rbenv install jruby-1.6.5</code>, respectively. This is our recommended procedure for folks
already using RVM or rbenv. It’s also possible to build/install JRuby 1.6.x snapshots using
<code class="language-plaintext highlighter-rouge">rvm install --branch jruby-1\_6 jruby-head</code>.</p>

<p>Windows users may be interested in <a href="https://github.com/vertiginous/pik">pik</a>, an RVM-like
tool for managing Ruby installations. It supports JRuby, naturally.</p>

<p>There are also JRuby packages for most major Linux and BSD variants. They’re not always
up-to-date, however.</p>

<p>Finally, you can clone JRuby from the <a href="http://github.com/jruby/jruby">JRuby github repository</a>
and build the jruby-1_6 branch.</p>

<h3 id="jruby-17x-in-development">JRuby 1.7.x (in development)</h3>

<p><em>Update:</em> <a href="http://www.jruby.org/2012/05/21/jruby-1-7-0-preview1">JRuby 1.7.0.preview1</a> has been released!
We are very interested in bug reports for the new invokedynamic support, and wanted to get
this preview out for people to test. There will be issues, don’t think for a moment there
will not…but that’s what previews and release candidates are for. Help us make 1.7.0
awesome!</p>

<p>JRuby 1.7 is not out yet…we had been waiting for OpenJDK 7u2 to drop before starting
our finalization process. But we’re looking for folks to start playing with it now. Until we
release JRuby 1.7, you can get it a few different ways.</p>

<p>Simplest is probably to grab a snapshot from the JRuby’s
<a href="http://ci.jruby.org/snapshots/master">master snapshots page</a>. You’ll find the usual complement
of packages and installers there.</p>

<p>RVM can install JRuby master using <code class="language-plaintext highlighter-rouge">rvm install jruby-head</code>.</p>

<p>And of course, you can clone from <a href="http://github.com/jruby/jruby">Github</a> and build the master
branch yourself, by running <code class="language-plaintext highlighter-rouge">ant</code>. JRuby runs fine from the working copy.</p>

<h2 id="use-the-right-java-version">Use the Right Java Version</h2>

<p>Ironically, the most complicated part of this process is making sure your system is set up
correctly to use Java 7 instead of some other version. The simple answer is to hardcode the
Java 7 bin/ dir in your shell’s PATH, but that’s both inelegant and incompatible with some
systems’ preferred mechanisms. Here’s a short survey of more elegant ways to easily swap Java
versions.</p>

<h3 id="linux">Linux</h3>

<p>As with most things, Linux variants don’t agree on how to manage multiple alternative versions
of a given package. Below I summarize the “blessed” way to do it on various Linux flavors.</p>

<p>Alternatively, you can rig up a trivial shell function or script that, when run, rewrites your
environment to point at the target Java installation. See the “pickjdk” script for OS X below.</p>

<h4 id="debian-variants-debian-ubuntu-etc">Debian variants (Debian, Ubuntu, etc)</h4>

<p>On Debian, your command of choice will be update-java-alternatives. This resets a set of
global symlinks to point at the Java installation you prefer. It’s not the most elegant way,
since the change is made globally, but it is the blessed way.</p>

<h4 id="redhat-variants">RedHat variants</h4>

<p>RedHat has a similar command called “alternatives”, under which there’s a “java” namespace.
the JBoss 5 docs have a nice page on
<a href="http://docs.redhat.com/docs/en-US/JBoss_Enterprise_Web_Platform/5/html/Installation_Guide/sect-use_alternatives_to_set_default_JDK.html">setting the default JDK on RHEL</a></p>

<h4 id="gentoo-and-other-linux-variants">Gentoo and other Linux variants</h4>

<p>I have so far been unable to find a way to easily manage multiple installed Java versions on
Gentoo. Feel free to submit suggestions in the comments.</p>

<p><em>Update</em>: Gentoo’s mechanism is the <code class="language-plaintext highlighter-rouge">java-config</code> command. <code class="language-plaintext highlighter-rouge">java-config -L</code> lists all
installed runtimes, and <code class="language-plaintext highlighter-rouge">java-config -set X</code> sets the default to runtime X.</p>

<h3 id="windows">Windows</h3>

<p>On Windows, your best best is generally to put the preferred Java version’s bin/ dir in PATH.
If you have other suggestions, feel free to comment.</p>

<h3 id="os-x-1">OS X</h3>

<p>Your best option will be to use the oft-tweaked “pickjdk” script, which scans installed JDK
versions and presents a menu. Selecting a version rewrites your environment to point at that
version. I prefer <a href="https://gist.github.com/1234935">my pickjdk variant</a>, since it allows specifying an install number directly
without going through the menu.</p>

<p>An alternative is to configure your environment manually. Java installations are located under
<code class="language-plaintext highlighter-rouge">/Library/Java/JavaVirtualMachines</code>; set JAVA_HOME to
<code class="language-plaintext highlighter-rouge">/Library/Java/JavaVirtualMachines/1.7.0u.jdk/Contents/Home</code>and prepend $JAVA_HOME/bin to
your PATH. You’re ready to go.</p>

<p><em>Update</em>: There’s an easy way to find available JAVA_HOMEs: the <code class="language-plaintext highlighter-rouge">java_home</code> command.
<code class="language-plaintext highlighter-rouge">/usr/libexec/java_home</code> will return the path to the default JVM (from Java Preferences).
You can also specify <code class="language-plaintext highlighter-rouge">-v 1.7</code> for the first Java 7 (1.7) install, or pass <code class="language-plaintext highlighter-rouge">-V</code> to
list all available JVMs.</p>

<p>You can also open up the Java Preferences utility (located in /Applications/Utilities)
and drag your preferred Java version to the top. This is a <em>global</em> change, and will affect
any programs that use the default Java version. Because the GUI parts of the OS X Java 7
preview are still in development, THIS IS NOT RECOMMENDED.</p>

<h3 id="other-oses">Other OSes</h3>

<p>I don’t know the proper mechanism for managing Java installations on the other BSDs
or on Solaris. Feel free to comment.</p>

<h2 id="try-it-out">Try It Out!</h2>

<p>Once you’ve got JRuby installed and in PATH (via whatever mechanism) and Java 7 installed
and in PATH (via whatever mechanism), you’re ready to test it out! Start up <code class="language-plaintext highlighter-rouge">jirb</code>,
launch your favorite JRuby-based app, or just run some benchmarks.</p>

<p>If you’re especially interested in performance, try out
<a href="https://raw.github.com/jruby/jruby/master/bench/bench_red_black.rb"><code class="language-plaintext highlighter-rouge">bench/bench_red_black.rb</code></a>
from JRuby’s benchmark suite. It’s a pure-Ruby implementation and benchmark of a red/black
tree, and a good representation of the kind of performance improvements you should see
from JRuby on Java 7. There’s plenty of other benchmarks in our suite and in the wild…
play around and let us know how it goes.</p>

<h2 id="what-to-expect">What to Expect</h2>

<p>Java 7 brings a lot of performance updates, even without invokedynamic. If you’re using JRuby
1.6.x, you should see an immediate performance improvement moving from Java 6 to Java 7. I
have heard reports of anywhere from 10-30% faster applications.</p>

<p>If you’re trying out JRuby master (1.7), you should see even more significant improvements.
JRuby 1.7’s use of invokedynamic means that Ruby code runs faster, optimizes better, and uses
fewer resources. In fact, if you <em>don’t</em> see better performance with JRuby 1.7 versus JRuby
1.6 on Java 7, please report an issue at <a href="http://bugs.jruby.org">JRuby’s bug tracker</a>. You’ve
probably found a flaw in our compiler…a flaw we’ll want to fix before release.</p>

<p>As a bit of a teaser, here’s <a href="https://gist.github.com/1493911">my numbers running the red/black tree benchmark</a>
from above (the numbers are time in seconds). Compared to JRuby on Java 6, JRuby
on Java 7 <em>without</em> invokedynamic is around 25% faster, and JRuby with invokedynamic is nearly
<em>3 times</em> faster.</p>

<p>It’s also worth mentioning that invokedynamic isn’t “done”. There’s a new optimizer planned for
Java 7u4 and my OpenJDK friends tell me there are many opportunities to increase performance.
JRuby on Java 7 will just keep getting faster.</p>

<p>JRuby has room to grow as well. We’re using invokedynamic heavily for the upcoming 1.7 release,
but there’s many places yet to be adapted. The performance you see today is not the end of the
story…there’s a lot more we can do.</p>

<h2 id="your-turn">Your Turn</h2>

<p>That’s about it for this tutorial. Hopefully you’ll be up and running on JRuby with Java 7
very quickly. If you have any trouble, please comment…we’ll try update this article with
fixes and suggestions. And I repeat my call for feedback on JRuby master + Java 7…this is
the future of JRuby, and it could be the future of high-performance Ruby. Let’s work together
to make it awesome!</p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2011/12/jruby-ci-keeping-it-real" rel="bookmark">
      <hgroup class="entry-title">
        <h1>JRuby CI: Keeping it Real</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:headius@headius.com" rel="email">Charles Oliver Nutter</a>
      <i>on</i> <time pubdate datetime="2011-12-16">December 16, 2011</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>Building a Ruby implementation is a long and challenging project. There’s thousands of
tests you need to pass, tens of thousands of libraries you need to run, and lots of
edge cases you need to discover and fix over time. Perhaps even more challenging is
keeping your Ruby implementation working from release to release, commit to commit.
Continuous integration is an absolute necessity.</p>

<p>JRuby has had a CI server for at least the past five years, running hand-rolled
options at first, and later to <a href="http://jenkins-ci.org/">Jenkins</a> (nee Hudson) where we will stay for the
foreseeable future. This post will help you understand how much effort we put into
remaining compatible and stable over time, and how you can track JRuby’s dev process
from a CI perspective.</p>

<h2 id="the-server">The Server</h2>

<p>As mentioned above, we run Jenkins for our CI server. The <a href="http://ci.jruby.org">ci.jruby.org</a>
machine runs on EC2 on a modest-sized instance funded by <a href="http://engineyard.com">Engine Yard</a>. There are dozens
of builds running on that machine, and it’s busy almost 24 hours a day.</p>

<p>There are several dimensions across which we test JRuby:</p>

<ul>
  <li>“master” versus “release” - Currently 1.7 dev versus 1.6.x, the master branch and jruby-1_6 branch.</li>
  <li>basic versus extended versus “all” tests - The “test” builds are doing our normal “test” target,
which runs quickly and includes a smaller subset of the full suite. These take about 3-5 minutes.
The “test-all” builds run an extended suite of tests across many combinations of JRuby
settings, and take anywhere from 30 to 60 minutes (run nightly).</li>
  <li>JVM vendor and version - We run our basic suite across several JVMs and try to keep them
green…but it’s a challenge.</li>
  <li>RubySpecs - We run the full RubySpec suite across several combinations of JRuby settings.</li>
  <li>Domain-specific tests - We ensure the jruby-complete.jar works properly, jruby libraries like
jruby-rack and jruby-openssl pass their tests, and various rails releases pass their tests as
well. These aren’t always kept green, since they depend on external repos and changes, but we
try to periodically tidy them up.</li>
  <li>Platform-specific tests - We also run our test suite on Windows, and have several test runs
for Ruboto, the JRuby-on-Android framework.</li>
</ul>

<p>It’s probably safe to say JRuby runs more tests in more combinations than any other Ruby
implementation, including MRI itself. What do the tests include?</p>

<h2 id="the-suite">The Suite</h2>

<p>JRuby’s test suite obviously includes our own JRuby-specific tests, but over time it has grown
to include several other suites.</p>

<ul>
  <li>JRuby’s tests and specs - These are largely testing JRuby-specific features like Java
integration or our Java-facing embedding APIs. We also have some tests for JRuby-specific
enhancements to core Ruby functionality, like URL support in File and Dir methods.</li>
  <li>Legacy runit and minirunit tests - Inherited from older suites in MRI, this suite has slowly
been shrinking over time.</li>
  <li>MRI’s test suite - In order to keep up with MRI’s feature changes, we also run MRI’s suite
in various forms. Most recently, we started running MRI 1.9.3’s test suite unmodified, using
the new “excludes” feature in minitest.</li>
  <li>Rubicon - Rubicon was a suite of tests written originally to support the “Programming Ruby”
book from PragProg. We have always run it, and over time tidied it up and just use our local
copy. This too has shrunk over time, as we move more tests into RubySpec.</li>
  <li>The ruby_test suite - This is a suite of tests created by Daniel Berger to support his
“facets” project. We run them just because.</li>
  <li>Our “main” Java-based suite - A set of JUnit test for JRuby’s Java APIs.</li>
  <li><a href="http://rubyspec.org">RubySpec</a> - And of course, we run RubySpec for both 1.8 and 1.9 modes. If we encounter bugs
or missing tests, we almost always add to RubySpec, rather than to any of the other suites.</li>
</ul>

<p>All six of these test groups are run as part of the “test-extended” and “test-all” targets,
adding up to literally millions of assertions.</p>

<h2 id="the-snapshots">The Snapshots</h2>

<p>In order to aid people testing JRuby, and to give people easier access to the latest features
on master and fixes on our release branches, we publish nightly snapshots to <a href="http://ci.jruby.org/snapshots">ci.jruby.org/snapshots</a>.</p>

<p>Here you will find <a href="http://ci.jruby.org/snapshots/1.7.x">1.7.x</a> and <a href="http://ci.jruby.org/snapshots/1.6.x">1.6.x</a> builds, or if you
prefer to use our rolling development aliases,
<a href="http://ci.jruby.org/snapshots/master">master</a> and <a href="http://ci.jruby.org/snapshots/release">release</a> builds.</p>

<h2 id="your-turn">Your Turn</h2>

<p>There’s a lot to track on our CI server, and we’d love your help in keeping builds green or
fixing builds that are red. We’re also looking to add other key libraries to our CI server,
to help ensure we’re maintaining a high level of compatibility. If you think you can help,
post a message to the JRuby dev list, or ping <a href="http://twitter.com/jruby">@jruby</a> on Twitter!</p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2011/11/gracious-eloise-interview" rel="bookmark">
      <hgroup class="entry-title">
        <h1>Gracious Eloise Interview</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:cwgem@jruby.org" rel="email">Chris White</a>
      <i>on</i> <time pubdate datetime="2011-11-20">November 20, 2011</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>It’s always interesting to see how JRuby is being utilized by our users. Sometimes it’s ways we expect, other times the results are unexpected. Rebecca Miller-Webster (<a href="https://twitter.com/#!/rmillerwebster">@rmillerwebster</a>), Head of Technology at <a href="http://www.graciouseloise.com/">Gracious Eloise</a> (<a href="https://twitter.com/#!/graciouseloise">@graciouseloise</a>), posted a blog entry titled <a href="http://www.rebeccamiller-webster.com/2011/11/the-power-of-jruby/">The Power of JRuby</a> showing a rather interesting use of JRuby. Wanting to know more about how JRuby fit into Gracious Eloise’s architecture, I conducted an interview so that users could see what kind of exciting things people are doing with JRuby!</p>

<h2 id="to-start-off-what-is-gracious-eloise-and-what-problem-does-it-look-to-solve">To start off, what is Gracious Eloise and what problem does it look to solve?</h2>

<p>Gracious Eloise is making handwriting digital and handwritten notes as easy as email. We are creating a platform that allows business and individuals to write handwritten notes from their computer – the notes are either printed, stamped, and mailed or emailed (coming soon!)</p>

<p>Our founder, Eloise Bune, came up with the idea when she had to write 300 thank you notes after her wedding.  In the process of building the algorithm and talking with investors, she realized that companies in many sectors, such as retail, non-profits, car dealerships, elected officials, and PR, currently have handwritten note programs that they are unable to scale or ensure quality and corporate standards.  That’s where Gracious Eloise comes in.</p>

<h2 id="when-did-you-first-find-out-about-jruby">When did you first find out about JRuby?</h2>

<p>I had heard rumblings of JRuby for a while – a friend who is a Ruby and Java/Hadoop guy kept suggesting it to me for Gracious Eloise.  Our handwriting replication algorithm is written in Mathematica, and I was struggling to build a Java web service that would allow our web app to connect to it.</p>

<h2 id="at-what-point-did-you-decide-to-use-jruby-and-was-it-a-tough-decision">At what point did you decide to use JRuby, and was it a tough decision?</h2>

<p>After struggling to get a Spring MVC web service to just return JSON without a view, I gave myself 2 hours to try to do it in JRuby.  It was done and working in 30 minutes.  Not a tough decision at all!</p>

<h2 id="how-does-jruby-fit-in-to-your-current-architecture">How does JRuby fit in to your current architecture?</h2>

<p>JRuby is the glue that connects everything together.  It connects our handwriting replication code (with a light Java wrapper around it) to our MRI Ruby on Rails web app via Resque jobs.  Ultimately, we will get rid of the Java code altogether and move that into JRuby as well as rewriting some or all of the handwriting replication algorithm using JRuby.  Because we can use Java’s image and graphics libraries, JRuby is a huge win for us in terms of the algorithm itself.</p>

<h2 id="what-is-the-architecture-like-that-keeps-everything-running">What is the architecture like that keeps everything running?</h2>

<p>We have Mathematica, Java, and JRuby running together in EC2 to do algorithm related processing. Our web app is Rails 3 with Backbone.js running on Heroku.  Pusher allows us to send messages about the status of processing to the web app.  Handwriting data is stored in MySQL (RDS), while customer and other web app related data is in Postgres.</p>

<h2 id="what-do-you-consider-to-be-jrubys-strengths-and-weaknesses">What do you consider to be JRuby’s strengths and weaknesses?</h2>

<p>As I said in a recent blog post, I think the biggest strength of JRuby is that it opens you up to using any Java library out there.  Used in conjunction with Resque and MRI or REE Ruby, you can also use any C library out there.  Basically, JRuby hands you most of the world of code on a platter.</p>

<p>As for weaknesses, I think it’s biggest weaknesses are Java’s biggest weaknesses.   And I’m mostly talking about Java’s insane love of memory. :)  Obviously, using the JVM and having access to Java libraries have huge advantages, so as with all technology choices, it’s a trade off.  But, again, you could always have code that is a memory-suck in Java moved to C and connect with other JRuby code in Resque.  JRuby allows you to choose the best tool for each job at hand and that, to me, is huge.</p>

<h2 id="you-mentioned-that-you-were-looking-for-a-jruby-developer-what-kind-of-work-would-be-involved">You mentioned that you were looking for a JRuby developer. What kind of work would be involved?</h2>

<p>The main project our <a href="http://careers.stackoverflow.com/jobs/14749/ruby-jruby-developer-gracious-eloise">JRuby Developer</a> would tackle would be creating an app for processing handwriting samples, likely a combination desktop and web app.  Currently, the process of getting someone’s handwriting is a huge pain and requires a review process that is terrible to do in Mathematica.  We have some code for this here and there, but it would really be building something from scratch.  Beyond that, the job would involve keeping the glue between the algorithm and the web app working and improving the speed and efficiency.  Also, helping our algorithm engineers move code out of Mathematica.</p>

<p>We are super small (i.e. I’m the only full-time developer), so if someone wanted to work on the web app side or the algorithm side as well that is on the table.  There’s also work to do with printer and email provider integration as well as CRM integration.</p>

<h2 id="thank-you-for-taking-the-time-for-this-interview-do-you-have-any-closing-words-for-our-readers">Thank you for taking the time for this interview! Do you have any closing words for our readers?</h2>

<p>JRuby rocks my world!</p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2011/11/jrubycommunity" rel="bookmark">
      <hgroup class="entry-title">
        <h1>JRuby Community Improvements</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:cwprogram@live.com" rel="email">Chris White</a>
      <i>on</i> <time pubdate datetime="2011-11-17">November 17, 2011</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>JRuby community guy Chris White (<a href="https://twitter.com/#!/cwgem">@cwgem</a>) here. First off as I’ll be offering topics you can contact me about, here’s the best ways to do so:</p>

<ul>
  <li>IRC: cwgem  @ freenode</li>
  <li>Mail: cwprogram at live dot com</li>
  <li>Twitter: <a href="https://twitter.com/#!/cwgem">@cwgem</a></li>
</ul>

<p>As of late I’ve been getting more involved in helping with the JRuby community, and finding out the best ways to reach out to new and existing users. Knowing who your community is helps to understand what needs should be filled, and what possible pain points are. That’s why I’ve made a few changes that I’d like to talk about to hopefully get you, the community, involved with JRuby better.</p>

<h2 id="twitter-accounts">Twitter Accounts</h2>

<p>Previously JRuby related tweets were getting spread across multiple accounts, and the JRuby official account was somewhat dry with content. Twitter is a great information aggregator, and those using the service often want a centralized place to check on related content. If someone asks “Where’s the best place to get JRuby related information?”, the answer should always have an official account with regularly updated content. So with this in mind I’m working with other JRuby team members to keep the account fresh. So please be sure to follow <a href="https://twitter.com/#!/jruby/">@JRuby</a> on Twitter to stay up to date on happenings!</p>

<p>Now another interesting issue I’ve run into is that there are a few JRuby job postings that trickle through on twitter. At first my main thought was to talk about them on the main @JRuby account. However the problem with that is it has the potential to make @JRuby perceived as a “spammy” account. Also the point of the account is to get job openings pushed out to people that actually care about them. This means they need to be focused to such users. @JRuby can’t achieve this well because the expectation isn’t setup to keep your eyes on the account for updates. To help alleviate these issues, the <a href="https://twitter.com/#!/JRubyJobs/">@JRubyJobs</a> account has been created. If you’re an employer looking for JRuby developers, or a JRuby developer who wants to use their skills in the workplace, be sure to check the account out! Those wanting to have JRuby job opportunities posted to the account please cc @JRubyJobs on the listing, DM the account, or send me an email.</p>

<h2 id="jruby-map">JRuby Map</h2>

<p>An interesting question that comes up regarding open source communities is where everyone is from. In the internet age open source users are often spread across the globe, sometimes in unexpected places. To attempt to get an idea of where our JRuby users are, I created the <a href="http://preview.tinyurl.com/jrubyusers">JRuby User Map</a>. My hope is to have a more populated map, so that I can see where our biggest user communities lie, but also make sure the smaller communities are recognized as well. Smaller communities are often put off as not worthwhile. However my belief is that these smaller communities are much more crucial. These are users who are working with JRuby in an environment where there is less support, which shows a tremendous amount of dedication. If you’re part of such a community and need help growing please contact me through Twitter or email.</p>

<p>For those of you who haven’t added themselves to the map, be sure to check out the <a href="http://blog.jruby.org/2011/11/communitymap">blog post showing how the process works</a>. It’s only a few steps and helps us get to know our community better!</p>

<h2 id="surveys">Surveys</h2>

<p>The best way to get to know users is to ask them questions. With this in mind I created a two surveys and casually posed a JRuby OS/App Server question on twitter. Some results simply confirmed my suspicions, others were quite interesting.</p>

<h3 id="java-version-survey">Java Version Survey</h3>

<p>First was the <a href="http://www.surveybuilder.com/s/KQrnk-yKwAA?source_id=3&amp;source_type=web">Java Version Survey</a>. The purpose of this survey was to understand which Java version people were running JRuby with. There were a total of 83 respondents to this survey. As the answer was multiple choice, the number of selections, 104, was greater than the number of respondents. As for how the data ended up:</p>

<ul>
  <li>Java 8 - 1 user (1%)</li>
  <li>Java 7 - 28 users (27%)</li>
  <li>Java 6 - 72 users (69%)</li>
  <li>Java 5 - 3 users (3%)</li>
</ul>

<p>This was more a confirmation of my assumptions. For the most part people are on Java 6, which makes sense as Java 7 came out recently. It also matches the JRuby 1.7 dev (trunk) usage. If you’re using trunk then upgrading to Java 7 is recommended to utilize the invokedynamic enhancements! There’s one brave Java 8 user, and a few Java 5 users still remaining.</p>

<h3 id="jruby-version-survey">JRuby Version Survey</h3>

<p>Next was to figure out what JRuby version was being used, and what the ratio of 1.8 and 1.9 mode usage was. This particular survey was split into four questions, two development environment questions and two production environment questions (optional of course). There were a total of 59 respondents. The allocation of responses were as follows:</p>

<ul>
  <li>JRuby Development Version - 79 answers</li>
  <li>JRuby Development Ruby Mode - 59 answers</li>
  <li>JRuby Production Version - 66 answers</li>
  <li>JRuby Production Ruby Mode - 54 answers</li>
</ul>

<p>There weren’t too many respondents who use JRuby only for development. The gap between JRuby dev respondents and answers is most likely due to people running multiple versions for testing. Personally I run 1.6.5 and trunk at the same time! Now for the results:</p>

<h4 id="jruby-development-version">JRuby Development Version</h4>

<ul>
  <li>JRuby 1.7 dev (git master) - 9 users (11%)</li>
  <li>JRuby 1.6.5 - 46 users (58%)</li>
  <li>JRuby 1.6.4 - 12 users (15%)</li>
  <li>JRuby 1.6.3 - 5 users (6%)</li>
  <li>JRuby 1.6.2 - 2 user (3%)</li>
  <li>JRuby 1.6.1 - 1 user (1%)</li>
  <li>JRuby 1.5 - 3 users (4%)</li>
  <li>JRuby 1.4 and lower - 1 user (1%)</li>
</ul>

<p>Most users are around 1.6.4 and 1.6.5, with a good number using trunk. This is expected for development use.</p>

<h4 id="jruby-development-1819-mode">JRuby Development 1.8/1.9 Mode</h4>

<ul>
  <li>Ruby 1.8 Mode - 19 users (32%)</li>
  <li>Ruby 1.9 Mode - 28 users (47%)</li>
  <li>Both - 12 users (12%)</li>
</ul>

<p>This was not too surprising. A majority of development users are on 1.9 mode, with the rest between 1.8 mode or both 1.8 and 1.9 mode.</p>

<h4 id="jruby-production-version">JRuby Production Version</h4>

<ul>
  <li>JRuby 1.7 dev (git master) - 2 users (3%)</li>
  <li>JRuby 1.6.5 - 37 users (56%)</li>
  <li>JRuby 1.6.4 - 9 users (14%)</li>
  <li>JRuby 1.6.3 - 8 users (12%)</li>
  <li>JRuby 1.6.2 - 1 users (2%)</li>
  <li>JRuby 1.6.1 - 1 user (2%)</li>
  <li>JRuby 1.5 - 6 users (9%)</li>
  <li>JRuby 1.4 and lower - 1 user (3%)</li>
</ul>

<p>The 2 users of 1.7 dev was a bit of a surprise. If you’re out there and reading this please shoot me an email on how you’re using it and how it’s working for you! There are a lot of 1.6.5 users, which means a majority of users are good about keeping up to date (since 1.6.5 was very recently released). There are noticeable number of 1.5 users, which is understandable given that some business are very conservative about technology related changes. If however there’s a bug or other reason which is blocking you from upgrading to the 1.6 please let us know! Having everyone on the same page is what we’d like to achieve.</p>

<h4 id="jruby-1819-mode">JRuby 1.8/1.9 Mode</h4>

<ul>
  <li>Ruby 1.8 mode - 26 users (48%)</li>
  <li>Ruby 1.9 mode - 17 users (31%)</li>
  <li>Both - 11 users (20%)</li>
</ul>

<p>The results here were a bit intriguing, as I was expecting a far larger gap between 1.8 and 1.9 mode usage. It will be interesting to revisit this question again when JRuby 1.7 becomes officially released. For those using both 1.8 and 1.9 mode, let us know how the Ruby mode usage is split up for your particular case.</p>

<h3 id="jruby-and-rails-deployment-survey">JRuby and Rails Deployment Survey</h3>

<p>The question was posed as to what OS and what app server was used for JRuby and Rails deployment. Most users mentioned that they were doing development work on Mac OS X, which is normal for the Ruby community in general. The server operating systems were a mix of RedHat and Debian based (RedHat, CentOS, Fedora, Debian, Ubuntu). There were a few Windows users (Windows 2008 Server), and a Solaris and AIX user. As for the app servers, Tomcat had the lead with Jetty, Trinidad and Torquebox also getting mentions.  A few users also mentioned WebSphere and Glassfish.</p>

<p>This leads me to the conclusion that:</p>

<ul>
  <li>We need to ensure the install guide for these app servers is up to date, especially the widely used Tomcat server.</li>
  <li>On that note finding links to the official pages of specific distributions on installing JRuby would be helpful</li>
  <li>A lot of users were noting that Mac OS X is their main development box, so revisiting the installer and ensuring it meets its needs would be a good idea</li>
</ul>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2011/11/communitymap" rel="bookmark">
      <hgroup class="entry-title">
        <h1>The JRuby User Map</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:cwprogram@live.com" rel="email">Chris White</a>
      <i>on</i> <time pubdate datetime="2011-11-13">November 13, 2011</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>Google maps provides an interesting feature for creating personalized maps. It is possible to allow these custom maps to be edited by others using collaboration features. With this in mind I’ve created a <a href="http://preview.tinyurl.com/jrubyusers">JRuby Users Map</a>. The map looks like this at the moment:</p>

<p><img src="http://i.imgur.com/V8IRn.png" alt="JRuby User Map" /></p>

<h2 id="adding-yourself-to-the-map">Adding Yourself To The Map</h2>

<p>Adding yourself to the map takes a few simple steps. First off you will need a Google account to access the map. For those of you who don’t, see the wiki instructions at the end. Once logged in, click on the link to the map given. Then search for the location that you wish to add. As an example I’ll search for Portland to add the Engine Yard Portland office:</p>

<p><img src="http://i.imgur.com/H2Qxc.png" alt="Portland Search" /></p>

<p>Next click on “Save To Map” on the left hand side. This will bring up a select box where you can select the “JRuby Users” map:</p>

<p><img src="http://i.imgur.com/EOTpx.png" alt="Save To Map" /></p>

<p>Finally, click “Save” to confirm and your location will be added:</p>

<p><img src="http://i.imgur.com/KNCZG.png" alt="Location Saved" /></p>

<p>Now you can also customize the location marker. To do so, return to the JRuby Users map using the original link. Then click the “Edit” button on the left, which will allow you to edit your entry:</p>

<p><img src="http://i.imgur.com/bqHdW.png" alt="Editing A Location" /></p>

<p>Make your edits (in this case I edited the title to “Engine Yard (Portland)”) and click “Save”, then “Done” on the left hand side to complete. This is the final result after the edit:</p>

<p><img src="http://i.imgur.com/TAqz6.png" alt="The EY Portland Office Shown" /></p>

<h2 id="-you-can-also-add-yourself-to-the-wiki">… You Can Also Add Yourself To The Wiki!</h2>

<p>JRuby Guy Charles Nutter has also created a wiki page on the JRuby wiki titled <a href="https://github.com/jruby/jruby/wiki/In-Your-Region">In Your Region</a> that you can add yourself to as well. This is alternative to those with JS restrictions of some sort, or those who don’t have a Google account.</p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2011/11/jruby-clojurescript" rel="bookmark">
      <hgroup class="entry-title">
        <h1>JRuby and ClojureScript Goodness</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:cwprogram@live.com" rel="email">Chris White</a>
      <i>on</i> <time pubdate datetime="2011-11-11">November 11, 2011</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>While Java is a major language on the JVM, it’s not the only one JRuby can interface with. JRuby can work with other JVM languages such as Scala, Groovy, and Clojure. JRuby committer Yoko Harada (<a href="https://twitter.com/#!/yokolet">@yokolet</a>) has been doing some interesting work with <a href="https://github.com/clojure/clojurescript">ClojureScript</a>, a Clojure to JS compiler. This post will take a look at how JRuby was used to help bring ClojureScript to Tilt, and in doing so the Rails Asset Pipeline.</p>

<h2 id="clojurescript-and-tilt">ClojureScript and Tilt</h2>

<p>The first experiment was getting ClojureScript to work with <a href="https://github.com/rtomayko/tilt">Tilt</a>, which is a “Generic interface to multiple Ruby template engines”. Yoko’s blog post <a href="http://yokolet.blogspot.com/2011/11/tilt-template-for-clojurescript.html">Tilt Template for ClojureScript</a> describes the process of getting the two technologies to work together. JRuby’s jar import functionality was used to interact with the ClojureScript related jars, which allowed Ruby to be used to bring everything together. For those interested in taking a look, there is a <a href="https://github.com/yokolet/clementine">git repository</a> with the code available to check out.</p>

<h2 id="clojurescript-and-the-rails-asset-pipeline">ClojureScript and The Rails Asset Pipeline</h2>

<p>It doesn’t stop there though! Since ClojureScript was available to Tilt, the next step was seeing if that could be used to interface with the <a href="http://guides.rubyonrails.org/asset_pipeline.html">Rails Asset Pipeline</a>. The guide has a short snippet on registering gems with Tilt to get them recognized by Sprockets, which Yoko describes in the blog post <a href="http://yokolet.blogspot.com/2011/11/clojurescript-on-rails-asset-pipeline.html">ClojureScript on Rails Asset Pipeline</a>. A great example of how JRuby can be use to do cool things with cool JVM technologies! This is also another reason to keep your eyes on the <a href="https://github.com/yokolet/clementine">git repository</a> to watch for new developments.</p>

<h2 id="you-can-do-closure-too">You Can Do Closure Too!</h2>

<p>ClojureScript uses the <a href="http://code.google.com/closure/">Google Closure compiler</a> behind the scenes to make the JS compilation process happen. <a href="http://www.instellaplatform.com/">Instella</a> CEO <a href="https://twitter.com/#!/dylancvaughn">Dylan Vaughn</a> was inspired by a post on Closure Templates Discuss titled <a href="https://groups.google.com/group/closure-templates-discuss/browse_thread/thread/50d977fcc121953b">Closure Templates in Ruby</a> to take a look on bringing JRuby and Closure together. Using some code for using <a href="https://github.com/igrigorik/closure-sprockets">Closure’s soy compiler with the Rails Asset Pipeline</a> by Googler <a href="https://twitter.com/#!/igrigorik">Ilya Grigorik</a>, he was able to interface the two together. The result of this is the <a href="https://github.com/dylanvaughn/closure-templates">closure-templates gem</a>, installable with <code class="language-plaintext highlighter-rouge">gem install closure-templates</code>. Be sure to check it out!</p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2011/11/jruby-conferences" rel="bookmark">
      <hgroup class="entry-title">
        <h1>Recent JRuby Conference Videos and Materials</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:cwprogram@live.com" rel="email">Chris White</a>
      <i>on</i> <time pubdate datetime="2011-11-08">November 08, 2011</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>At any one time there always seems to be a number of conferences coming up or taking place. These conferences are an excellent way to interact with members of the JRuby community. However not everyone can make it to every single conference. Fortunately sites like <a href="http://confreaks.net/">Confreaks</a>, <a href="http://www.slideshare.net/">SlideShare</a>, and <a href="http://lanyrd.com/">Lanyard</a> have made it easy to access pre-recorded conference videos, slides, and other materials. This post is meant to introduce some highlight videos and materials from recent conferences where JRuby presentations were held.</p>

<h2 id="but-first-jrubyconf-is-coming">But First, JRubyConf Is Coming!</h2>

<p>As was <a href="https://twitter.com/#!/JRubyConf/status/134019937818771456">announced on Twitter</a>, JRubyConf 2012 will be taking place in Minneapolis, Minnesota from May 21st - 23rd. The JRuby team has some great things planned, so be sure to keep your eyes on the <a href="https://twitter.com/#!/JRubyConf">@JRubyConf</a> account for more updates.</p>

<h2 id="startech-conf">StarTech Conf</h2>

<h3 id="building-languages-for-the-jvm">Building Languages for the JVM</h3>

<p>It used to be that Java was the main language to interface with the JVM. This has changed with languages such as Clojure, Scala, and Groovy stepping up to provide alternative ways to utilize the platform. What exactly goes into making a language for it? JRuby Guy Charles Nutter takes a look at the challenges for implementing a language using JRuby as a case study. Slides for the presentation are available on <a href="http://www.slideshare.net/CharlesNutter/star-techconf-2011-jvm-languages">slideshare</a>.</p>

<h2 id="ruby-midwest">Ruby Midwest</h2>

<h3 id="recommendation-engines-using-machine-learning-and-jruby">Recommendation Engines using Machine Learning, and JRuby</h3>

<p>Wonder how a site like NetFlix recommends movies to users? Matt Kirk discusses how such recommendation engines work and how to implement one in JRuby. <a href="http://matthewkirk.com/presentations/Support-Vector-Machines-with-Jruby.pdf">PDF Slides</a> are available from the author’s website.</p>

<h3 id="high-performance-ruby-threading-versus-evented">High Performance Ruby: Threading versus Evented</h3>

<p>While not specific to JRuby, Dr. Nic takes a look at the often debated topic of threaded versus evented when dealing with high performance Ruby. In particular JRuby is mentioned for how it handles the threaded concurrency issue. Slides are available on <a href="http://speakerdeck.com/u/drnic/p/high-performance-ruby-threading-versus-evented-ruby-midwest-edition">Slideshare</a> for viewing (there’s also a PDF download link). There’s also a <a href="http://windycityrails.org/videos2011/#1">recorded video of a previous version of the talk from Windy City Rails</a>.</p>

<h2 id="ruby-conference">Ruby Conference</h2>

<h3 id="be-a-minecraft-modman-with-purugin">Be a Minecraft modman with Purugin</h3>

<p>Minecraft is a game that has gained an immense following. Users explore worlds and construct things along the way. However, there are a unique set of users who like to tinker around with the game and create mods for it. These users are known as modman, or so JRuby team member Thomas Enebo has decided to call them. This talk discusses Purugin, a framework that uses JRuby to allow for creating Minecraft plugins using Ruby syntax. A video of the talk is available at <a href="http://confreaks.net/videos/696-rubyconf2011-be-a-minecraft-modman-with-purugin">Confreaks</a>.</p>

<h3 id="jruby-polyglot-heaven">JRuby: Polyglot Heaven</h3>

<p>With languages such as Scala, Clojure, and Groovy setting a new trend for languages on the JVM, projects utilizing multiple languages are not a rare site. This talk by JRuby team members Charles Nutter and Thomas Enebo takes a look at how JRuby can be used to interact with other JVM languages. A video of the talk is available at <a href="http://confreaks.net/videos/684-rubyconf2011-jruby-polyglot-heaven">Confreaks</a>.</p>

<h3 id="jruby-and-big-data">JRuby and Big Data</h3>

<p>Jeremy Hinegardner presents different ways that JRuby can work with big data. The talk discusses interfacing with big data solutions such as <a href="http://hadoop.apache.org/">Apache Hadoop</a>, <a href="http://hadoop.apache.org/hdfs/">HDFS</a>, <a href="http://avro.apache.org/">Avro</a>, and more. A video of the talk can be found on <a href="http://confreaks.net/videos/674-rubyconf2011-jruby-and-big-data">Confreaks</a> and <a href="http://www.youtube.com/watch?v=MBXH0P5tB2g">Youtube</a>.</p>

<p><strong>Update</strong> Added RubyConf Brazil Talks. Thanks to @qmx on twitter for the heads up!</p>

<h2 id="rubyconf-brazil">RubyConf Brazil</h2>

<h3 id="jruby-on-steroids">JRUBY ON STEROIDS</h3>

<p>Technology is constantly improving, and the JVM is no exception. JRuby contributor Douglas Campos  takes a look at Java7’s improvements for dynamic languages, and how JRuby benefits from them. <a href="http://cdn.qmx.me/presentations/2011/rubyconfbr/index.html">HTML Slides</a> can be found on the author’s website. A video recording in Brazilian Portuguese can be found at <a href="http://www.eventials.com/rubyconfbr/recorded/M2UzZTJkMzY2MzdiNTg2NTUxNWM1MzI3NWY1YjRhMzYjIzM5Ng_3D_3D">eventials</a>.</p>

<h3 id="torquebox---crossing-the-chasm-between-java-and-ruby">TORQUEBOX - CROSSING THE CHASM BETWEEN JAVA AND RUBY</h3>

<p>Scale is always a hot topic in the web development world. However you don’t have to reinvent the wheel to achieve it. TorqueBox contributor Bruno Oliveira looks at how Rails/Sinatra/Rack applications can be combined with JVM technologies to provide scalable applications. Slides can be found at <a href="http://www.slideshare.net/bruno.abstractj/torquebox-ultrapassando-a-fronteira-entre-java-e-ruby">slideshare</a>. A video recording in Brazilian Portuguese can be found at <a href="http://www.eventials.com/rubyconfbr/recorded/M2UzZTJkMzY2MzdiNTg2NTUxNWM1MzI3NWY1YjRhMzYjIzM5OQ_3D_3D">eventials</a>.</p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2011/10/why-isnt-jruby-implemented-in-ruby" rel="bookmark">
      <hgroup class="entry-title">
        <h1>Why Isn't JRuby Implemented in Ruby?</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:headius@headius.com" rel="email">Charles Oliver Nutter</a>
      <i>on</i> <time pubdate datetime="2011-10-24">October 24, 2011</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>As Ruby implementations mature and Ruby code runs faster and faster,
the question starts to come up again and again: why not implement
more in Ruby? There’s many good reasons to do it: easier for Rubyists
to maintain and contribute; no native library dependencies; better
visibility for debuggers and profilers; consistency all the way into
the core… the list goes on. As you’d expect, we often get this
question about JRuby itself, given that JRuby now runs Ruby code very
fast and most Rubyists would rather not read or write Java code. So
why isn’t JRuby implemented in Ruby?</p>

<p>The answer: it’s complicated.</p>

<h2 id="ruby-is-not-the-best-language-for-everything">Ruby is Not the Best Language for Everything</h2>

<p>The simplest answer is perhaps the most obvious: Ruby isn’t always
the best tool. There’s many cases where Ruby’s dispatch overhead,
coercion protocols, arbitrary-precision integers, or mutable types
get in the way of expressivity or performance. What makes Ruby
“beautiful” sometimes obscures intent from either the programmer or
the underlying platform.</p>

<p>Performance is obviously a key issue. Sometimes, you really need raw
native maths or byte arrays and Fixnum, Float, and Array introduce too
much overhead. Using Java gives us a “known quantity” when it comes
to performance.</p>

<p>Now of course I’m not saying Ruby won’t continue to get faster and
faster. JRuby on Java 7 has started to approach Java performance for
many algorithms, and as JRuby and the JVM improve, the gap will
continue to narrow. But optimizing a dynamic language is challenging
even on the best VMs, so it’s nice to have that “known quantity”
when performance is critical.</p>

<h2 id="jrubys-a-ruby-implementation-and-a-jvm-language">JRuby’s a Ruby Implementation <em>and</em> a JVM Language</h2>

<p>Then there’s also the matter of interfacing with statically-typed JVM
libraries. JRuby makes heavy use of JVM libraries for much of its
internals. That has meant we don’t have to implement our own
collections, IO subsystem, JVM bytecode generator, YAML 1.1, and
much more. Of course some of these could be called via our Java
integration layer, but there’s always a bit more overhead down that
road than by having Java calling Java.</p>

<p>Almost as important is the fact that nearly all of JRuby’s core
classes can be called as normal Java classes from any piece of JVM
code. Java integration is a two-way street, and having Ruby-only
implementations would make one direction more challenging to
support.</p>

<h2 id="dont-throw-out-the-baby">Don’t Throw Out the Baby</h2>

<p>Moving to Ruby for new code is easy enough, but moving existing
code to Ruby would mean throwing out known-working, battle-tested,
optimized Java implementations for something completely new. Any
good developer knows that a “big rewrite” seldom ends well, so
we’d be doing a great disservice to the thousands of JRuby users
out there by making a wholesale move to Ruby. There’s no measure
of benefit (from rewriting in Ruby) that would outweigh losing
years of maturity in our codebase.</p>

<h2 id="inertia">Inertia</h2>

<p>Inertia may be the biggest motivator here. The JRuby committers
are very familiar with Java and with the current implementation.
They also may know Ruby very well, but change is always
accompanied by some measure of confusion.</p>

<p>Most of the JRuby core team manages a subset of JRuby; Tom Enebo
works on parser, interpreter, and the new IR compiler. Nick Sieger
works on libraries like activerecord-jdbc and jruby-rack. Wayne
Meissner works on our native library integration layers like FFI.
I work on compilation, optimization, and Java integration. Do we
force everyone to start writing in Ruby when they may prefer to use
Java?</p>

<h2 id="developer-pool">Developer Pool</h2>

<p>As much as Ruby has grown in recent years, there are still far
more Java developers in the world. They may not <em>love</em> the
language, but they represent a tremendous potential pool of
contributors to JRuby. Yes, it’s true that a Java developer is
probably less likely to contribute to JRuby than a Rubyist…
but there’s still a hell of a lot of them out there.</p>

<p>There’s also a very large portion of JRuby users (perhaps even
a majority) that are either primarily or originally Java folks.
Having a mostly-Java codebase means they can more easily
investigate bugs, integrate JRuby into their JVM-based
applications, and generally reason about how JRuby <em>actually</em>
works. That’s very powerful.</p>

<h2 id="but-we-still-want-to-do-it">But We Still Want to Do It!</h2>

<p>Even though I list a bunch of reasons for having a mostly
Java codebase, we do recognize that Ruby is an excellent tool
for both writing apps and for implementing Ruby’s core. And
we have always intended to make it possible for JRuby to use
more Ruby code as part of the core implementation, even if
we never do a wholesale rewrite.</p>

<p>To that end, I’ve started restructing the (admittedly small)
Ruby-based “kernel” of JRuby into a structure that’s more
approachable to Rubyists that want to contribute to JRuby. The
restructured Ruby kernel is under <a href="https://github.com/jruby/jruby/tree/master/src/jruby">src/jruby</a>,
and while there’s not much there right now we’re willing to
accept new code in either Ruby <em>or</em> Java. If it becomes a
performance or integration problem, we may rewrite that code
in Java…but having a working implementation in Ruby is far
better than having nothing at all.</p>

<h2 id="whither-rubinius">Whither Rubinius?</h2>

<p>You might be asking yourself “why not just use <a href="https://github.com/rubinius/rubinius">Rubinius</a>’s
kernel?” We’ve always hoped (maybe intended) to use as much
as possible of Rubinius’s mostly-Ruby kernel in JRuby, if
at some point that seemed feasible. With recent performance
improvements in JRuby, that day may be approaching. We would
need to patch away anything that’s Rubinius-specific, but I
have toyed with how to start using Rubinius’s kernel in JRuby
several times in the past few years. If we can borrow their
code for missing or poorly-implemented parts of JRuby, it
would be stupid for us not to do so.</p>

<p>It’s also worth pointing out that Rubinius has very few of the
challenges JRuby does when it comes to integrating with an
existing platform. Rubinius was designed as a Ruby VM alone,
so there’s no equivalent to Java integration. When Rubinius
wants to utilize native libraries, they do what we do: write
wrapper logic in C/++ (equivalent to JRuby’s Java code) or bind
those libraries with FFI (similar to but more basic than our Java
integration). And Rubinius exposes no native, statically-typed
API to its implementation classes.</p>

<h2 id="how-can-you-help">How Can You Help?</h2>

<p>Right now we’re looking to use Ruby mostly for missing features.
Since we’re still in the midst of filling out Ruby 1.9.2 and
1.9.3 features, that’s a good place to start.</p>

<p>We use and contribute to RubySpec, just like Rubinius does,
so you can easily find missing or broken features by looking under
<a href="https://github.com/jruby/jruby/tree/master/spec/tags">spec/tags</a>
in our codebase.</p>

<p>(RubySpec supports the concept of “tagging”, where known-failing
specs can be “tagged” until they pass. This allows implementations
to maintain a “watermark” of passing specs over time, and allows
contributors to easily see and fill in implementation gaps.)</p>

<p>You’ll want to fetch the revision of RubySpec we currently test
against by running <em>rake spec:fetch_stable_specs</em> (or <em>ant
fetch-stable-specs</em>; git must be installed in both cases), but
after that you can run specs using <a href="https://github.com/rubyspec/mspec">spec/mspec/bin/mspec</a>
in the usual way.</p>

<p>And of course if there are Ruby 1.8 or 1.9 features that are
weakly specified by available tests, we strongly encourage
you to contribute specs directly to the <a href="http://rubyspec.org/">RubySpec</a>
project, so that all implementations can benefit.</p>

<p>We hope that making it easier to implement JRuby using Ruby
code will make it more approachable to Rubyists, and we’re
looking forward to helping you craft your first pull request! Stop
by #jruby on Freenode IRC this week and we’ll help you out!</p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2011/10/the-painting's-on-the-wall" rel="bookmark">
      <hgroup class="entry-title">
        <h1>The Painting's on the Wall</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:veganstraightedge@gmail.com" rel="email">Shane Becker</a>
      <i>on</i> <time pubdate datetime="2011-10-13">October 13, 2011</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>The fine folks at <a href="http://lunarlogicpolska.com" title="Agile Ruby on Rails offshore development experts - Lunar Logic Polska">Lunar Logic Polska</a> love JRuby so much that they put their money where their mouth is. Or rather, they put their paint where their heart is. Showing their affection for JRuby, they painted <a href="http://twitter.com/headius/status/110383651321155584">JRuby Duke on their office wall</a> for everyone to see.</p>

<p>First, they used a projector to trace the image onto the wall (an effective and simple solution that I’ve used before too).</p>

<p><a href="https://plus.google.com/photos/116133683664833809819/albums/5648208621355151441/5648069536162686882"><img src="http://jruby.org/images/blog.jruby.org/10-2011/jruby-duke-painting-at-lunar-logic-polska-1.jpg" alt="Tracing the image onto the wall" /></a></p>

<p>Many hands make light work.</p>

<p><a href="https://plus.google.com/photos/116133683664833809819/albums/5648208621355151441/5648081364918986146"><img src="http://jruby.org/images/blog.jruby.org/10-2011/jruby-duke-painting-at-lunar-logic-polska-2.jpg" alt="Two people painting" /></a></p>

<p>Almost there. Almost there.</p>

<p><a href="https://plus.google.com/photos/116133683664833809819/albums/5648208621355151441/5648088994116813986"><img src="http://jruby.org/images/blog.jruby.org/10-2011/jruby-duke-painting-at-lunar-logic-polska-3.jpg" alt="Rough draft" /></a></p>

<p>Putting on the finishing touches.</p>

<p><a href="https://plus.google.com/photos/116133683664833809819/albums/5648208621355151441/5648127313070080274"><img src="http://jruby.org/images/blog.jruby.org/10-2011/jruby-duke-painting-at-lunar-logic-polska-4.jpg" alt="Polishing the details" /></a></p>

<p>The final product.</p>

<p><a href="https://plus.google.com/photos/116133683664833809819/albums/5648208621355151441/5648130242076135122"><img src="http://jruby.org/images/blog.jruby.org/10-2011/jruby-duke-painting-at-lunar-logic-polska-5.jpg" alt="Finished painting" /></a></p>

<p>Clearly, the Lunar Logic Polska team is full of very smart and good looking people!</p>

<p><a href="https://plus.google.com/photos/116133683664833809819/albums/5648208621355151441/5649601724908159026"><img src="http://jruby.org/images/blog.jruby.org/10-2011/jruby-duke-painting-at-lunar-logic-polska-6.jpg" alt="Lunar Logic Polska team" /></a></p>

<p><a href="https://plus.google.com/photos/116133683664833809819/albums/5648208621355151441">See the full gallery on Konrad Malawski’s Google Plus account.</a></p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2011/09/bringing-jruby-to-the-cloud" rel="bookmark">
      <hgroup class="entry-title">
        <h1>Bringing JRuby to the Cloud</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:headius@headius.com" rel="email">Charles Oliver Nutter</a>
      <i>on</i> <time pubdate datetime="2011-09-28">September 28, 2011</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>My friends, I’m proud to announce we’ve reached another milestone with JRuby: the full, non-beta, general availability of <a href="http://www.engineyard.com/blog/2011/jruby-ga-on-an-engine-yard-cloud-near-you/">Engine Yard Cloud’s JRuby support</a>!</p>

<p>The release of JRuby on our Cloud comes after years of work on JRuby and months of work by <a href="http://twitter.com/calavera">David Calvera</a>, <a href="http://twitter.com/hiro_asari">Hiro Asari</a>, and the awesome <a href="http://docs.engineyard.com/appcloud-tech-stack.html">stack team</a> at Engine Yard. It is, in many ways, the “big goal” we had when <a href="http://twitter.com/tom_enebo">Tom Enebo</a>, <a href="http://twitter.com/nicksieger">Nick Sieger</a> and <a href="http://twitter.com/headius">I</a> came to Engine Yard in 2009 to continue working on JRuby. We’re very excited to have accomplished our big goal for JRuby at Engine Yard, and will now look forward to new goals and milestones. But what does this mean to you? And how did we get here?</p>

<h2 id="jruby-on-engine-yard-cloud">JRuby on Engine Yard Cloud</h2>

<p>If you’ve ever used Engine Yard Cloud before, you already know what it feels like. JRuby support looks and feels pretty much the same; you just select JRuby from the Ruby versions drop-down, choose Trinidad, and deploy your app as normal. Provisioning, deployment, and migration all happen for you automatically. You can configure Trinidad to spin up enough JRuby instances to handle your concurrent load, or run “threadsafe” using a single instance. And that’s it! You have your JRuby application in the cloud, with support from the best team in the Ruby cloud universe.</p>

<p>The Cloud’s support for JRuby represents milestones for the wider Ruby world, too. It’s obviously the first cloud to officially support JRuby, but it’s also the first cloud with a concurrency-capable Ruby and the first cloud supporting an alternative Ruby implementation. You get the best cloud with the best support story and one of the best Ruby implementations on one of the best VMs in the world. What’s not to love?</p>

<p>We at Engine Yard and on the JRuby team are very proud to have finally achieved this milestone. Let’s take a look back at the past five years of JRuby that led us to this point.</p>

<h2 id="a-brief-history">A Brief History</h2>

<p>I’ve talked about the history of JRuby in many posts, and I’m preparing one on JRuby’s 10-year anniversary as you read this. The journey really started in 2006, when Tom and I first demonstrated JRuby running a Rails application at JavaOne. That was <a href="http://sourceforge.net/project/shownotes.php?release_id=405255">JRuby 0.8.3</a>, and six months prior we couldn’t even run IRB. In those days, the JVM world was just starting to explore alternative languages, with most of that attention on Jython and Groovy. Scala, Clojure, and the other half-dozen “new” JVM languages you may have heard about were either still growing up or still hiding behind the curtain of academia.</p>

<p>That first demo saw JRuby running on WEBrick, because there were no other servers for JRuby yet. No native DB support existed for JRuby, so we had to get the pure-Ruby MySQL driver working. We were able to install gems and run IRB, but the Rails console didn’t work and everything felt ready to fly apart. Just days before JavaOne, we got it working.</p>

<p>Tom and I were sitting at the Espresso Royale coffee shop near the University of Minnesota campus, walking through the basic CRUD operations and making sure everything functioned. It all seemed to work – and that was very exciting – but the performance was really dreadful. It took seconds for each page refresh, sometimes so long we thought the app had hung.</p>

<p>On a hunch, we started looking for Rails tuning advice. One page talked about something called “development mode” and highly recommended using “production mode” for production applications. Without any other leads, we flipped the switch…and the JRuby on Rails age dawned! Performance was not spectacular, but it was totally acceptable for a first public showing. Rails was running atop the JVM, and JRuby made it possible!</p>

<p>A year later, Tom and I had accepted positions at Sun Microsystems and were preparing to release <a href="http://blog.headius.com/2007/06/jruby-10-released.html">JRuby 1.0</a> for JavaOne 2007. We were optimistic…we felt like JRuby was ready for simple, non-critical production apps, and we were eager to show the JVM world what we could do. This time, we had Nick Sieger’s ActiveRecord-JDBC for database access and an early precursor to jruby-rack called “GoldSpike” (after the golden spike that joined east to west in the early USA rail system) to allow servlet engines to serve up Rails requests.</p>

<p>JRuby 1.0 was fully interpreted, quite slow, and far less Ruby-compatible than JRuby today, but it worked. And it was enough to draw in a few early production users like Oracle and Thoughtworks.</p>

<p>The next year saw the release of <a href="http://docs.codehaus.org/display/JRUBY/2008/04/05/JRuby+1.1+Released">JRuby 1.1</a>, the first Ruby implementation ever to incorporate a runtime just-in-time (JIT) compiler to improve performance. We were starting to beat Ruby 1.8 on simple benchmarks, and stability kept increasing.</p>

<p>JRuby has had many more releases, always focusing on the user’s experience and the user’s needs. JRuby 1.1.1 through 1.1.6 made huge leaps forward in compatibility and performance, and JRuby 1.2 may have been the first release <em>really</em> ready for production. <a href="http://www.jruby.org/2009/06/03/jruby-1-3-0.html">JRuby 1.3</a>, <a href="http://jruby.org/2009/11/02/jruby-1-4-0">1.4</a>, and <a href="http://jruby.org/2010/05/12/jruby-1-5-0.html">1.5</a> each involved thousands of commits and hundreds of fixed bugs, along with more and more production users ranging from <a href="http://www.osl.no/en/osl">airports</a> to the <a href="http://www.seti.org/ata">Allen Telescope Array</a>.</p>

<p>This year, we released <a href="http://jruby.org/2011/03/15/jruby-1-6-0.html">JRuby 1.6</a> with Ruby 1.9 features and experimental support for C extensions, and have done four 1.6.x maintenance releases (with a fifth just around the corner). JRuby 1.7 will take advantage of the new “invokedynamic” support in Java 7, and runs far faster than any previous release.</p>

<p>JRuby is now more compatible and boasts better performance than ever before, and has earned a place in both the Ruby and Java worlds.</p>

<h2 id="jruby-meets-the-cloud">JRuby meets the Cloud</h2>

<p>The earliest talk about JRuby at Engine Yard started in late 2008. <a href="http://twitter.com/tmornini">Tom Mornini</a> reached out to us, interested in talking about what a JRuby-powered Engine Yard offering might look like. We talked on and off with him and other Engine Yarders in early 2009, and finally visited the Engine Yard office to talk seriously about making something happen.</p>

<p>We were lost deep within another cloud: the cloud of doubt hanging over the Oracle takeover of Sun Microsystems. With change in the air, Tom, Nick and I accepted new positions at Engine Yard, and the wheels were set in motion for JRuby support.</p>

<p>It was a hard slog to get here. Engine Yard’s cloud was under heavy development, marketing, and rebranding, so we kept cranking out JRuby releases and helping anyone with available cycles get to know JRuby better. In early 2010, Engine Yard hired Hiro Asari, a long time JRuby contributor also interested in making a move. Hiro became the first-ever-anywhere JRuby support engineer, and we launched official commercial support for JRuby later that year.</p>

<p>The arrival at engine yard of David Calavera, creator of the Trinidad server, finally gave us the missing piece needed for JRuby on Engine Yard Cloud. We went to alpha stage early in 2011 and to beta some months later for RailsConf.</p>

<p>With a few production users under our belt, we decided RubyConf 2011 was the right time to go to GA (general availability). And here we are!</p>

<h2 id="next-steps-for-you">Next Steps For You</h2>

<p>Engine Yard wants to help you bootstrap your application, and to do so we’re continuing to offer <a href="http://engineyard.com/tryjruby">500 free compute hours</a>. That applies to JRuby too, so there’s really no reason <em>not</em> to give it a shot. If you’ve ever wanted to try deploying to JRuby, or if you’ve never played with Engine Yard Cloud, today is the day!</p>

<p>All the Engine Yard JRuby team members will also be at RubyConf this week, and we’ll be holding continuous office hours wherever we stand (perhaps with some scheduled office hours too) to help you get started on Engine Yard Cloud, help you attempt a migration to JRuby, or just to hear what you want from JRuby. We’ve done all this work for you, the Rubyists and JRubyists of the world, and we want you to have the best experience possible!</p>

<p>Finally, I’d really like everyone to send a big “Thank You” to <a href="http://twitter.com/engineyard">@engineyard</a> on Twitter. Without their support these past couple years, JRuby would not have made so much progress. Without a commercial support offering, several large JRuby users might never have used Ruby at all. And now, with official cloud support, deploying JRuby is a fire-and-forget proposition. Engine Yard helped us bring JRuby to maturity, and the Ruby world is a better place as a result.</p>

<p>Thank you all, friends, for your support these many years. I hope to hear from each and every one of you, and you can rest assured more great things are coming from JRuby and Engine Yard.</p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2011/09/help-wanted-javaOne-scriptbowl" rel="bookmark">
      <hgroup class="entry-title">
        <h1>HELP WANTED JavaOne Script Bowl Demos</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:tom.enebo@gmail.com" rel="email">Thomas E. Enebo</a>
      <i>on</i> <time pubdate datetime="2011-09-22">September 22, 2011</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>JavaOne Script Bowl (<a href="https://oracleus.wingateweb.com/scheduler/eventcatalog/eventCatalogJavaOne.do">Weds. Oct. 5, 8:30am</a>) is an annual event at <a href="http://www.oracle.com/javaone/index.html">JavaOne</a> where various languages which run on the JVM get to showcase the best they have to offer in two short ~5 minute segments: technology and community.  Ruby (via JRuby) has been involved in this event for the four years it has existed.  This year we are facing off against Clojure, Scala, and Groovy.  We are trying to prepare for this event and we need your help!</p>

<p>The main goal of this event is for Java language programmers to get a good taste of what the alternative JVM languages have to offer.  By the end of the script bowl, the typical attendee has hopefully been infected with the desire to look into one or more new languages.  Our goal is to entice the attendee to fall in love with Ruby.</p>

<p>For the technology segment we plan on showing several things which make Ruby shine in comparison to other JVM languages (Java included).   We plan on showing the simplicity of Sinatra; The brevity and power of Rake along with JRuby’s Java Ant integration;  The future of Jenkins via Ruby plugins;  Also perhaps a display of our ability to install any Maven artifact as it it were a Ruby gem.  We are still open to any other cool technology demos, so if you can cook up a cool demo then let us know.</p>

<p>For the community segment we are looking for examples/demos which underscore why the Ruby community is worth taking notice of.  Rails is the 500 pound gorilla in the room, but technologies like Sass underscore how much innovation is happening in the Ruby community.  This segment can be done with live demos, but we are also looking for reasoned arguments of why the Ruby community is great.  A few other ideas: interesting testing technologies, zero-turnaround deploys.</p>

<p>So how can you help?  Please send us:</p>
<ul>
  <li>A cool demo using a Ruby technology</li>
  <li>A simple pitch (like 4-5 slides) showing an example of how the Ruby community shines</li>
</ul>

<p>If we end up using your idea or demo, you will get a <a href="http://blog.jruby.org/2011/09/jruby-tshirts/">JRuby t-shirt</a> as thanks for helping.  Hell, if we don’t use your idea but appreciate the effort you put into your submission, you may get a t-shirt anyways.</p>

<p>Your submissions, whether code or a tech pitch, should be sent to <strong>community@jruby.org</strong> as a link to a <a href="http://www.github.com">github.com</a> repository with a description of what you are sending us (also put it in the README in the repo).  Any pitches or demos will probably only be shown for 1 minute or less during script bowl so take this into consideration when making your submissions.  Oh….one more small detail: deadline for accepting submissions is Sept 30!  So get cracking and help us make this the most memorable Script Bowl yet.</p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2011/09/jruby-tshirts" rel="bookmark">
      <hgroup class="entry-title">
        <h1>New JRuby T-Shirts</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:veganstraightedge@gmail.com" rel="email">Shane Becker</a>
      <i>on</i> <time pubdate datetime="2011-09-14">September 14, 2011</time>
    </h3>

  </header>

  <section class="entry-content">
    <h1 id="i-heart-jruby-shirt">I Heart JRuby shirt</h1>

<p><a href="http://flickr.com/veganstraightedge/6142405678" title="I &lt;3 JRuby shirt, on Flickr"><img src="http://farm7.static.flickr.com/6195/6142405678_d2c5ba602e_z.jpg" alt="I &lt;3 JRuby shirt" /></a></p>

<p>Do you totally love JRuby? Of course you do. Want a t-shirt to show the world just how much you love JRuby? Of course you do. Here’s how you can get one.</p>

<ul>
  <li>Write up an amazing blog post about JRuby – your experience with it, something great you’ve learned about it (and yourself), clever solutions to tricky problems, etc</li>
  <li>Present about JRuby at a local meetup – try to video record it and post it online</li>
  <li>Give a talk about JRuby at a conference</li>
  <li>Convince the company that you work for to start using JRuby in its stack</li>
  <li>Get part of your work time budget to <a href="https://github.com/jruby/jruby">contribute to JRuby</a> and/or <a href="http://twitter.com/nicksieger/status/111172038349164545">JRuby related projects</a></li>
</ul>

<p>Do one of those things and you’ll earn yourself one of these super comfy t-shirts to wear proudly.</p>

<p><em>Stay tuned for how to request your shirt</em></p>

<h1 id="a-jruby-production-shirt">A JRuby Production shirt</h1>

<p><a href="http://flickr.com/veganstraightedge/6141860917" title="A JRuby Production shirt, on Flickr"><img src="http://farm7.static.flickr.com/6167/6141860917_e74a6f891c_z.jpg" alt="A JRuby Production shirt" /></a></p>

<p>Are you using JRuby in production? Are you willing to talk about it publicly? Will you let us interview you and/or your team to do a post about your experience? If so, we’ve got special t-shirts for you. Get in touch and tell us what you’re up to with JRuby and who we should talk to about it.</p>

<p>Email: <a href="mailto:community@jruby.org">community@jruby.org</a></p>

<hr />

<p><em>Shirts modeled by my friends Kristen and Alex at <a href="http://farmhouse.la" title="The Farmhouse">The Farmhouse</a> in Hollywood, California</em></p>


  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2011/09/ar-jdbc-1-2-0-released" rel="bookmark">
      <hgroup class="entry-title">
        <h1>activerecord-jdbc-adapter 1.2.0 Released!</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:nicksieger@gmail.com" rel="email">Nick Sieger</a>
      <i>on</i> <time pubdate datetime="2011-09-13">September 13, 2011</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>With the advent of our new <a href="http://blog.jruby.org">jruby.org blog</a>
comes a new software release. Our JDBC-based adapter for ActiveRecord
is now compatible with the <a href="http://weblog.rubyonrails.org/2011/8/31/rails-3-1-0-has-been-released">Rails 3.1 release</a>. AR-JDBC is
also tested to be compatible with 2.3.x and 3.0.x.</p>

<p>Install it as usual with <code class="language-plaintext highlighter-rouge">gem install activerecord-jdbc-adapter</code>.</p>

<p>A new and notable feature of Rails 3.1 is that support for AR-JDBC is
built-in. So when you generate a new Rails application with JRuby,
your Gemfile will be set up automatically for use with JRuby and
AR-JDBC. The <code class="language-plaintext highlighter-rouge">rails new</code> command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails new photoblog -d mysql
</code></pre></div></div>

<p>creates the following section of the <code class="language-plaintext highlighter-rouge">Gemfile</code>:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gem</span> <span class="s1">'activerecord-jdbcmysql-adapter'</span></code></pre></figure>

<p>So, no more <code class="language-plaintext highlighter-rouge">-m http://jruby.org</code>, no more <code class="language-plaintext highlighter-rouge">rails generate jdbc</code>,
nothing. JRuby on Rails works out of the box.</p>

<p>I also want to take a moment to welcome <a href="https://github.com/ajuckel">Anthony Juckel</a>,
<a href="https://github.com/arunagw">Arun Agrawal</a>, <a href="https://github.com/guilleiguaran">Guillermo Iguaran</a>, <a href="https://github.com/hexgnu">Matt
Kirk</a>, <a href="https://github.com/lukefx">Luca Simone</a>, and <a href="https://github.com/samuelkadolph">Samuel
Kadolph</a> for stepping up to the plate to help maintain
AR-JDBC going forward. Thanks everyone!</p>


  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2011/09/start" rel="bookmark">
      <hgroup class="entry-title">
        <h1>A Start</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:veganstraightedge@gmail.com" rel="email">Shane Becker</a>
      <i>on</i> <time pubdate datetime="2011-09-09">September 09, 2011</time>
    </h3>

  </header>

  <section class="entry-content">
    <h1 id="ready-set-go">Ready, Set… Go!</h1>

<table>
  <tbody>
    <tr>
      <td>For some time now, there’s been a <a href="http://jruby.org/atom.xml" title="JRuby.org News">unified feed of mostly release notes</a>. But never really a unified place for non-release notes information about JRuby. There was the [Engine Yard blog](http://www.engineyard.com/blog/?s=jruby “Jruby</td>
      <td>Engine Yard Ruby on Rails Blog”), <a href="http://blog.headius.com/" title="Headius">Charles Nutter’s blog</a>, <a href="http://blog.nicksieger.com" title="Nick Sieger">Nick Sieger’s blog</a>, <a href="http://blog.enebo.com" title="Tom's Ruminations">Tom Enebo’s blog</a> and <a href="http://www.google.com/search?q=jruby" title="jruby - Google Search">various other sources</a>. (The release notes feed will continue to exist. No need to change your feed readers.)</td>
    </tr>
  </tbody>
</table>

<p>Today we change that. You now are looking at the new home for news, information and all of the things JRuby related that aren’t release notes.</p>

<p>Tell your friends and stay tuned for more.</p>

  </section>

  
</article>

    </li>
  
    <li>
      <article role="article" class="hentry">
  <header>
    <a href="/2009/06/jruby-dot-org-launched" rel="bookmark">
      <hgroup class="entry-title">
        <h1>JRuby.org Launched!</h1>
        
          <h2></h2>
        
      </hgroup>
    </a>

    <h3 class="vcard">
      Published <i>by</i> <a href="mailto:community@jruby.org" rel="email">JRuby Team</a>
      <i>on</i> <time pubdate datetime="2009-06-13">June 13, 2009</time>
    </h3>

  </header>

  <section class="entry-content">
    <p>Of course we launched the new JRuby.org yesterday. There’s still some content to be refined/revised and plenty of styling to clean up, but it’s a vast improvement over our previous non-existent web presence. We’re thrilled with the design of the site and keen to add more useful content over the next couple weeks.</p>

<p>And for anyone interested, contact <a href="mailto:marknutter@gmail.com">marknutter@gmail.com</a> if you want to get a similarly smoov design for a site of your own.</p>

<p>Check it: <a href="http://www.jruby.org" title="Home &mdash; JRuby.org">http://www.jruby.org</a></p>

  </section>

  
</article>

    </li>
  
</ul>


  <footer role="contentinfo">
    <p>All post content is licensed under <a rel="license" href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons &mdash; Attribution 3.0 Unported">Creative Commons Attribution 3.0</a> unless stated otherwise by the author in that post.</p>
  </footer>

  <script>
    // google analytics
    var _gaq=[['_setAccount','UA-764576-26'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.async=1;
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
</body>
</html>
